<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AFK Live</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/theme.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üî¥</text></svg>">
</head>
<body>

<!-- Mobile Sidebar Overlay -->
<div id="sidebarOverlay" class="sidebar-overlay" onclick="toggleMobileMenu()"></div>

<div class="app-layout">

    <!-- LEVEL 1: ICON SIDEBAR (Channels/Orgs) -->
    <aside class="icon-sidebar">
        <a href="#" class="icon-btn logo-btn" title="AFK Live">üî¥</a>

        <div id="channelIconsList" class="channel-list">
            <!-- Populated via JS -->
        </div>

        <button class="icon-btn add-btn" onclick="openConnectModal()" title="Add Channel">
            <i class="fa-solid fa-plus"></i>
        </button>

        <div class="spacer"></div>

        <a href="#" class="icon-btn" onclick="switchView('settings')" title="Settings">
            <img src="" id="userAvatarSmall" class="avatar-small hidden">
            <i class="fa-solid fa-gear" id="settingsIcon"></i>
        </a>
    </aside>

    <!-- LEVEL 2: NAV SIDEBAR (Contextual) -->
    <nav class="sub-sidebar" id="subSidebar">
        <div class="sidebar-header">
            <h2 id="sidebarTitle">Publishing</h2>
            <div class="dropdown-trigger" onclick="toggleChannelDropdown()">
                 <span id="currentChannelName">All Channels</span> <i class="fa-solid fa-chevron-down"></i>
            </div>
            <!-- Dropdown Menu -->
            <div id="channelDropdownMenu" class="dropdown-menu">
                <!-- Populated via JS -->
            </div>
        </div>

        <div class="menu">
            <a href="#" class="menu-item active" data-target="view-publish" onclick="switchView('publish')">
                <i class="fa-regular fa-paper-plane"></i>
                <span>Queue</span>
            </a>
            <a href="#" class="menu-item" data-target="view-calendar" onclick="switchView('calendar')">
                <i class="fa-regular fa-calendar"></i>
                <span>Calendar</span>
            </a>
            <div class="menu-divider"></div>
            <a href="#" class="menu-item" data-target="view-stream" onclick="switchView('stream')">
                <i class="fa-solid fa-satellite-dish"></i>
                <span>Live Studio</span>
            </a>
             <a href="#" class="menu-item" data-target="view-community" onclick="switchView('community')">
                <i class="fa-regular fa-comments"></i>
                <span>Engagement</span>
            </a>
            <a href="#" class="menu-item" data-target="view-analytics" onclick="switchView('analytics')">
                <i class="fa-solid fa-chart-line"></i>
                <span>Analytics</span>
            </a>
            <a href="#" class="menu-item" data-target="view-library" onclick="switchView('library')">
                <i class="fa-regular fa-folder"></i>
                <span>Media Library</span>
            </a>
            <div class="menu-divider"></div>
             <a href="#" class="menu-item" data-target="view-settings" onclick="switchView('settings')">
                <i class="fa-solid fa-gear"></i>
                <span>Settings</span>
            </a>
        </div>

        <div class="sidebar-footer">
             <a href="#" class="menu-item" onclick="openSupportModal()">
                <i class="fa-regular fa-life-ring"></i>
                <span>Support</span>
            </a>
             <a href="/logout" class="menu-item logout">
                <i class="fa-solid fa-right-from-bracket"></i>
                <span>Logout</span>
            </a>
        </div>
    </nav>

    <!-- LEVEL 3: CONTENT -->
    <main class="content-area">

        <!-- Mobile Header -->
        <header class="mobile-header">
            <button class="hamburger" onclick="toggleMobileMenu()"><i class="fa-solid fa-bars"></i></button>
            <span class="mobile-title">AFK Live</span>
        </header>

        <div id="verificationBanner" class="hidden warning-banner">
            ‚ö†Ô∏è Please verify your email address to access all features.
        </div>

        <!-- VIEW: PUBLISH -->
        <div id="view-publish" class="view-section">
            <header class="page-header">
                <h1>Queue</h1>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="showScheduleModal()">
                        <i class="fa-solid fa-pen-to-square"></i> Create Post
                    </button>
                </div>
            </header>

            <div class="container-fluid">
                <div class="queue-list" id="queueList">
                     <!-- Populated JS -->
                </div>
            </div>
        </div>

        <!-- VIEW: STREAM (StreamYard Inspired) -->
        <div id="view-stream" class="view-section hidden" style="padding: 0; overflow: hidden;">
            <div class="stream-studio-grid">

                <!-- MAIN COL: Preview & Assets -->
                <div class="studio-main-col">
                    <div class="studio-preview-container">
                        <div class="studio-preview-wrapper">
                            <video id="previewPlayer" class="studio-preview-player hidden" controls playsinline></video>
                            <div id="previewPlaceholder" class="studio-preview-placeholder">
                                <i class="fa-solid fa-film fa-3x"></i>
                                <div style="margin-top:10px;">Select a video to start</div>
                                <button class="btn btn-primary btn-sm" onclick="openLibraryModalForStream()" style="margin-top:15px;">Select Source</button>
                            </div>
                            <div class="studio-live-badge hidden" id="studioLiveBadge">LIVE</div>
                        </div>
                    </div>

                    <!-- Compact Stream Control Bar -->
                    <div class="studio-source-bar">
                        <div class="source-info" onclick="openLibraryModalForStream()">
                            <div class="source-thumb">
                                <img id="selectedVideoThumb" src="" class="hidden">
                                <i id="selectedVideoIcon" class="fa-solid fa-film"></i>
                            </div>
                            <div class="source-details">
                                <div class="source-label">Current Source</div>
                                <div id="studioSelectedTitle" class="source-title">None Selected</div>
                            </div>
                            <div style="display:flex; gap:5px; margin-left:15px;">
                                <button class="btn btn-sm btn-outline" onclick="openLibraryModalForStream(event)" title="Select from Library"><i class="fa-solid fa-folder-open"></i></button>
                                <button class="btn btn-sm btn-outline" onclick="document.getElementById('streamVideoUploadDirect').click(); event.stopPropagation();" title="Upload Video"><i class="fa-solid fa-upload"></i></button>
                            </div>
                        </div>

                        <div class="source-actions">
                            <div class="action-toggle" title="Loop Video">
                                <input type="checkbox" id="streamLoopInfinite" checked>
                                <span class="toggle-label"><i class="fa-solid fa-repeat"></i> Loop</span>
                            </div>
                            <div class="action-toggle" title="Mute Source Audio">
                                <input type="checkbox" id="streamMuteOriginal" checked>
                                <span class="toggle-label"><i class="fa-solid fa-volume-xmark"></i> Mute Src</span>
                            </div>
                            <!-- Hidden inputs for logic -->
                            <input type="number" id="streamLoopCount" value="1" class="hidden">
                            <input type="file" id="streamUploadInput" hidden accept="video/*">
                            <input type="file" id="streamVideoUploadDirect" hidden accept="video/*">
                        </div>
                    </div>
                </div>

                <!-- RIGHT SIDEBAR: Tools -->
                <div class="studio-sidebar-right">

                    <div class="studio-header">
                        <h2>Stream Settings</h2>
                        <button id="btnGoLive" class="btn btn-danger" onclick="submitJob()">Go Live</button>
                        <button id="btnStop" class="btn btn-secondary hidden" onclick="stopStream()">Stop</button>
                    </div>

                    <div class="studio-tabs">
                        <div class="studio-tab active" onclick="switchStudioTab('streams')">Streams</div>
                        <div class="studio-tab" onclick="switchStudioTab('chat')">Chat</div>
                        <div class="studio-tab" onclick="switchStudioTab('brand')">Brand</div>
                        <div class="studio-tab" onclick="switchStudioTab('audio')">Audio</div>
                        <div class="studio-tab" onclick="switchStudioTab('settings')">Settings</div>
                    </div>

                    <div class="studio-content">

                        <!-- TAB: STREAMS -->
                        <div id="studio-tab-streams" class="studio-panel active">
                            <div class="empty-state" id="streamsEmptyState">
                                <i class="fa-solid fa-tower-broadcast"></i>
                                <p>No active streams</p>
                            </div>
                            <div id="activeStreamsList" class="activity-list"></div>
                        </div>

                        <!-- TAB: CHAT -->
                        <div id="studio-tab-chat" class="studio-panel">
                            <div class="empty-state" id="chatEmptyState">
                                <i class="fa-regular fa-comments"></i>
                                <p>Chats show up here</p>
                            </div>
                            <div id="studioChatList" class="sidebar-thread-list">
                                <!-- Populated via JS -->
                            </div>
                        </div>

                        <!-- TAB: BRAND -->
                        <div id="studio-tab-brand" class="studio-panel">
                            <span class="studio-section-title">Brand Customization</span>
                            <div class="studio-subpanel">
                                <label style="font-weight:600; font-size:0.85rem; display:block; margin-bottom:10px;">Logo / Watermark</label>
                                <button class="btn btn-outline btn-sm btn-block" onclick="document.getElementById('streamWatermarkFile').click()">
                                    <i class="fa-solid fa-upload"></i> Upload
                                </button>
                                <input type="file" id="streamWatermarkFile" accept=".png,.jpg" hidden onchange="handleWatermarkUpload(this)">

                                <div id="watermarkPreview" class="hidden" style="margin-top:10px; background:#e3f2fd; padding:10px; border-radius:4px; display:flex; align-items:center; gap:10px;">
                                    <img id="watermarkImg" src="" style="height:30px;">
                                    <button class="btn btn-text btn-xs" onclick="clearWatermark()" style="color:var(--text-muted);"><i class="fa-solid fa-xmark"></i></button>
                                </div>
                            </div>
                        </div>

                        <!-- TAB: AUDIO -->
                        <div id="studio-tab-audio" class="studio-panel">
                            <span class="studio-section-title">Audio</span>
                            <div class="studio-subpanel">
                                <div class="studio-audio-control">
                                    <button class="btn btn-xs btn-outline" onclick="switchStreamAudioTab('upload')">Upload</button>
                                    <button class="btn btn-xs btn-outline" onclick="switchStreamAudioTab('lib')">Stock</button>
                                    <button class="btn btn-xs btn-outline" onclick="switchStreamAudioTab('mylib')">Library</button>
                                </div>

                                <div id="streamAudioUploadSection" class="hidden">
                                    <input type="file" id="streamAudioFile" accept=".mp3,.wav" style="font-size:0.8rem;" onchange="handleStreamMusicUpload(event)">
                                    <input type="hidden" id="uploadedStreamMusicName">
                                </div>
                                <div id="streamAudioLibSection" class="hidden">
                                    <div id="streamAudioTrackList" class="studio-list" style="height:100px;">Loading...</div>
                                    <input type="hidden" id="selectedStreamStockId">
                                </div>
                                <div id="streamAudioMyLibSection" class="hidden">
                                    <div id="streamAudioMyTrackList" class="studio-list" style="height:100px;">Loading...</div>
                                    <input type="hidden" id="selectedMyLibMusicName">
                                </div>

                                <div style="margin-top:15px;">
                                    <label style="font-size:0.8rem;">Music Volume: <span id="streamVolVal">50%</span></label>
                                    <input type="range" id="streamAudioVol" min="0" max="200" value="50" style="width:100%" oninput="document.getElementById('streamVolVal').innerText = this.value + '%'">
                                </div>

                                <label style="display:flex; align-items:center; gap:8px; font-size:0.85rem; margin-top:10px; cursor:pointer;">
                                    <input type="checkbox" id="streamMuteOriginal" checked>
                                    Mute Video Sound
                                </label>
                            </div>
                        </div>

                        <!-- TAB: SETTINGS -->
                        <div id="studio-tab-settings" class="studio-panel">
                            <span class="studio-section-title">Destinations</span>
                            <div class="studio-subpanel">
                                <div id="destinationList" class="studio-dest-list"></div>
                                <button class="btn btn-text btn-sm btn-block" onclick="openAddDestinationChoiceModal()" style="margin-top:5px;">+ Add Destination</button>
                            </div>

                            <span class="studio-section-title">Stream Settings</span>
                            <div class="studio-subpanel">
                                <label style="font-size:0.8rem; font-weight:600;">Resolution</label>
                                <select id="streamQuality" class="form-input" style="margin-bottom:10px;">
                                    <option value="1080" selected>1080p (Full HD)</option>
                                    <option value="720">720p (HD)</option>
                                    <option value="2160">4K (Ultra HD)</option>
                                </select>

                                <label style="font-size:0.8rem; font-weight:600;">Orientation</label>
                                <select id="streamOrientation" class="form-input">
                                    <option value="original" selected>Landscape (16:9)</option>
                                    <option value="force_portrait">Portrait (9:16)</option>
                                </select>
                            </div>

                            <span class="studio-section-title">Broadcast Info</span>
                            <div class="studio-subpanel">
                                 <input type="text" id="streamMetaTitle" class="form-input" placeholder="Title" style="margin-bottom:8px;">
                                 <textarea id="streamMetaDesc" class="form-input" rows="3" placeholder="Description" style="margin-bottom:8px;"></textarea>
                                 <select id="streamMetaPrivacy" class="form-input" style="margin-bottom:8px;">
                                    <option value="public">Public</option>
                                    <option value="unlisted">Unlisted</option>
                                    <option value="private">Private</option>
                                 </select>
                                 <button class="btn btn-xs btn-outline btn-block" onclick="generateStreamMetadata()">
                                     <i class="fa-solid fa-wand-magic-sparkles"></i> AI Generate
                                 </button>
                                 <input type="hidden" id="aiStreamTopic">
                            </div>

                            <div style="text-align:center;">
                                <a href="#" onclick="switchStreamTab('schedule')" style="font-size:0.85rem;">Schedule for later</a>
                                <div id="streamActionSchedule" class="hidden studio-subpanel" style="text-align:left;">
                                     <label style="font-size:0.8rem;">Start Time</label>
                                     <input type="datetime-local" id="streamScheduleTime" class="form-input">
                                     <button class="btn btn-primary btn-sm btn-block" style="margin-top:5px;" onclick="submitScheduledStream()">Confirm Schedule</button>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: CALENDAR -->
        <div id="view-calendar" class="view-section hidden">
            <header class="page-header">
                <h1>Calendar</h1>
            </header>
            <div id="calendar" class="calendar-container"></div>
        </div>

        <!-- VIEW: COMMUNITY -->
        <div id="view-community" class="view-section hidden" style="padding: 20px;">
            <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                 <h2 style="margin:0;">Engagement</h2>
                 <button class="btn btn-outline btn-sm" onclick="showEngagementSettings()"><i class="fa-solid fa-robot"></i> AI Automation</button>
            </div>

            <div class="community-grid-layout">
                <!-- SIDEBAR -->
                <div class="comm-sidebar">
                    <div class="comm-nav-item active" onclick="filterCommTab('all')">
                        <i class="fa-solid fa-inbox"></i> All Comments
                    </div>
                    <div class="comm-nav-item" onclick="filterCommTab('unreplied')">
                        <i class="fa-regular fa-envelope-open"></i> Unreplied
                    </div>
                    <div style="margin: 15px 20px 5px; font-size: 0.75rem; font-weight: 700; color: #999; text-transform: uppercase;">Activity</div>
                    <div class="comm-nav-item" onclick="filterCommTab('activity')">
                        <i class="fa-solid fa-bolt"></i> Auto-Actions
                    </div>
                </div>

                <!-- LIST -->
                <div id="commListPanel" class="comm-list-panel">
                     <div style="padding: 15px; border-bottom: 1px solid var(--border);">
                         <input type="text" placeholder="Search..." class="form-input" style="font-size: 0.9rem;">
                     </div>
                     <div id="threadList" class="thread-list">
                         <!-- Populated via JS -->
                     </div>
                </div>

                <!-- ACTIVITY VIEW (Alternative to List/Detail) -->
                <div id="commActivityView" class="comm-detail-panel hidden" style="padding: 30px; overflow-y: auto; grid-column: span 2;">
                    <h3 style="margin-top:0;">Automation Log</h3>
                    <div id="activityList" class="activity-list"></div>
                </div>

                <!-- DETAIL -->
                <div id="commDetailView" class="comm-detail-panel">
                    <div id="emptyThreadState" class="empty-state" style="padding-top: 100px;">
                        <i class="fa-regular fa-comments"></i>
                        <p>Select a conversation to reply</p>
                    </div>

                    <div id="activeThread" class="hidden" style="display: flex; flex-direction: column; height: 100%;">
                        <div class="thread-header" style="padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #fafafa;">
                             <div style="font-weight: 600; font-size: 0.95rem; display: flex; align-items: center; gap: 8px;">
                                 <i class="fa-brands fa-youtube" style="color: red;"></i>
                                 <span id="threadVideoTitle">Video Title</span>
                             </div>
                             <a href="#" id="threadVideoLink" target="_blank" style="color: var(--text-muted);"><i class="fa-solid fa-external-link"></i></a>
                        </div>

                        <div id="threadMessages" class="thread-messages" style="flex: 1; overflow-y: auto; padding: 20px;">
                            <!-- Bubbles -->
                        </div>

                        <!-- AI Suggestions Area -->
                        <div id="aiSuggestionsArea" class="hidden" style="padding: 10px 20px; background: #f0f8ff; border-top: 1px solid #cce0ff;">
                            <small style="font-weight:600; color:#0052cc; display:block; margin-bottom:8px;">AI Suggestions:</small>
                            <div id="aiChips" style="display:flex; gap:8px; flex-wrap:wrap;"></div>
                            <button class="btn btn-sm btn-text" onclick="generateSuggestions()" style="font-size:0.8rem; margin-top:5px; padding-left:0;"><i class="fa-solid fa-rotate"></i> Refresh</button>
                        </div>

                        <div class="reply-box" style="padding: 20px; border-top: 1px solid var(--border); background: white;">
                            <textarea id="replyInput" placeholder="Write a reply..." rows="3" class="form-input" style="margin-bottom: 10px;"></textarea>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <button class="btn btn-sm btn-outline" onclick="toggleAiSuggestions()"><i class="fa-solid fa-wand-magic-sparkles" style="color: #8e44ad;"></i> AI Assist</button>
                                <button class="btn btn-primary" onclick="sendReply()">Reply</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: ANALYTICS -->
        <div id="view-analytics" class="view-section hidden">
             <header class="page-header">
                <h1>Analytics</h1>
                <select id="analyticsRange" class="form-select" onchange="initAnalytics()">
                    <option value="7">Last 7 Days</option>
                    <option value="28" selected>Last 28 Days</option>
                    <option value="90">Last 90 Days</option>
                    <option value="365">Last Year</option>
                </select>
            </header>

            <div class="summary-grid">
                 <div class="card summary-card">
                     <h3>Views</h3>
                     <p id="totalViews">0</p>
                 </div>
                 <div class="card summary-card">
                     <h3>Subscribers</h3>
                     <p id="totalSubs">0</p>
                 </div>
                 <div class="card summary-card">
                     <h3>Watch Time</h3>
                     <p id="totalWatchTime">0</p>
                 </div>
             </div>
             <div class="card chart-card">
                 <canvas id="analyticsChart"></canvas>
             </div>
        </div>

        <!-- VIEW: LIBRARY -->
        <div id="view-library" class="view-section hidden">
            <header class="page-header">
                <h1>Media Library</h1>
                <div class="header-actions">
                    <button class="btn btn-outline" onclick="openYouTubeImportModal()"><i class="fa-brands fa-youtube" style="color:red"></i> Import YouTube</button>
                    <button class="btn btn-outline" onclick="document.getElementById('bulkUploadInput').click()">Upload</button>
                    <input type="file" id="bulkUploadInput" multiple hidden accept="video/*,.zip">
                    <button class="btn btn-outline" id="btnDeleteSelected" disabled onclick="deleteSelectedVideos()" style="color: var(--danger); border-color: var(--danger);">Delete Selected</button>
                    <button class="btn btn-outline" id="btnMerge" disabled onclick="mergeSelectedVideos()">Merge Selected</button>
                    <button class="btn btn-primary" onclick="showAutoScheduleModal()">Auto-Schedule</button>
                </div>
            </header>
            <div style="margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between;">
                <label style="display:flex; align-items:center; gap:8px; font-weight:600; cursor:pointer;">
                    <input type="checkbox" id="selectAllLibrary" onchange="toggleSelectAllLibrary(this)">
                    Select All
                </label>
                <div id="libraryPaginationControls" style="display:flex; gap:10px; align-items:center;">
                    <!-- JS populated -->
                </div>
            </div>
            <div id="libraryList" class="queue-list"></div>
        </div>

        <!-- VIEW: SETTINGS -->
        <div id="view-settings" class="view-section hidden" style="padding: 20px;">
            <div class="settings-container">
                <div class="settings-sidebar">
                    <div class="settings-nav-item active" onclick="switchSettingsTab('general')">General</div>
                    <div class="settings-nav-item" onclick="switchSettingsTab('channels')">Channels</div>
                    <div class="settings-nav-item" onclick="switchSettingsTab('benefits')">My Benefits</div>
                    <div class="settings-nav-item" onclick="switchSettingsTab('plans')">Plans & Billing</div>
                </div>
                <div class="settings-content">

                    <!-- TAB: GENERAL -->
                    <div id="tab-general" class="settings-section">
                        <h2>General Settings</h2>
                        <div class="form-group">
                            <label>Connected Accounts</label>
                            <div class="queue-item">
                                <i class="fa-brands fa-google" style="font-size: 1.5rem;"></i>
                                <div style="flex:1">
                                    <div style="font-weight:600">Google Account</div>
                                    <div style="font-size:0.85rem; color:#666" id="settingsGoogleEmail">Connected</div>
                                </div>
                                <a href="/oauth2/authorization/google" class="btn btn-sm btn-outline">Reconnect</a>
                            </div>
                        </div>
                    </div>

                    <!-- TAB: CHANNELS -->
                    <div id="tab-channels" class="settings-section hidden">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                            <h2>Channels</h2>
                            <button class="btn btn-primary btn-sm" onclick="openConnectModal()">+ Add Channel</button>
                        </div>
                        <div id="channelListSettings" class="queue-list"></div>
                    </div>

                    <!-- TAB: BENEFITS -->
                    <div id="tab-benefits" class="settings-section hidden">
                        <h2>My Benefits</h2>
                        <div id="benefitsContent">Loading...</div>
                    </div>

                    <!-- TAB: PLANS -->
                    <div id="tab-plans" class="settings-section hidden">
                        <h2>Subscription</h2>
                        <!-- Usage -->
                        <div class="card" style="margin-bottom: 30px; background: #f9f9f9; border:none;">
                            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                                <span>Current Plan: <strong id="planName">Loading...</strong></span>
                                <span id="storageText">0/0</span>
                            </div>
                            <div class="progress-track"><div id="storageBar" class="progress-fill"></div></div>
                            <div style="margin-top: 15px; text-align: right;">
                                <button onclick="cancelSubscription()" class="btn btn-text btn-sm" style="color: var(--danger);">Cancel Subscription</button>
                            </div>
                        </div>

                        <h3>Available Plans</h3>
                        <div id="internalPlanGrid" class="plan-grid">
                            <!-- Loaded via JS -->
                        </div>
                    </div>

                </div>
            </div>
        </div>

    </main>
</div>

<!-- MODALS -->

<!-- Optimize Video Modal -->
<div id="optimizeModal" class="modal-overlay hidden">
    <div class="modal-box" style="width: 450px;">
        <div class="modal-header" style="border:none;">
            <h2>Optimize Video</h2>
            <button onclick="document.getElementById('optimizeModal').classList.add('hidden')" class="btn-close"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <p style="color:#666; margin-bottom:20px;">Create an optimized version for streaming.</p>

        <div class="form-group">
            <label>Format</label>
            <div class="platform-select">
                <div class="platform-option selected" onclick="selectOptimizeMode('landscape', this)">
                    <i class="fa-solid fa-desktop"></i> Landscape (16:9)
                </div>
                <div class="platform-option" onclick="selectOptimizeMode('portrait', this)">
                    <i class="fa-solid fa-mobile-screen"></i> Portrait (9:16)
                </div>
            </div>
        </div>

        <div class="form-group">
            <label>Quality / Resolution</label>
            <select id="optimizeQuality" class="form-input">
                <option value="1080">1080p (Full HD)</option>
                <option value="720">720p (HD)</option>
                <option value="2160">4K (Ultra HD)</option>
            </select>
        </div>

        <input type="hidden" id="optimizeFileName">
        <input type="hidden" id="optimizeMode" value="landscape">

        <div class="modal-actions" style="margin-top: 20px; text-align: right;">
            <button class="btn btn-text" onclick="document.getElementById('optimizeModal').classList.add('hidden')">Cancel</button>
            <button class="btn btn-primary" onclick="submitOptimization()">Start Optimization</button>
        </div>
    </div>
</div>

<!-- Connect Channel Modal -->
<div id="connectChannelModal" class="modal-overlay hidden">
    <div class="modal-box" style="width: 450px;">
        <div class="modal-header" style="padding: 0 0 20px 0; border: none;">
            <h2>Connect Channel</h2>
            <button onclick="document.getElementById('connectChannelModal').classList.add('hidden')" class="btn-close"><i class="fa-solid fa-xmark"></i></button>
        </div>

        <div class="form-group">
            <label>Select Platform</label>
            <div class="platform-select">
                <div class="platform-option selected" onclick="selectPlatform('YOUTUBE', this)">
                    <i class="fa-brands fa-youtube" style="color: red;"></i> YouTube
                </div>
                <div class="platform-option" onclick="selectPlatform('INSTAGRAM', this)">
                    <i class="fa-brands fa-instagram" style="color: #E1306C;"></i> Instagram
                </div>
                <div class="platform-option" onclick="selectPlatform('SNAPCHAT', this)">
                    <i class="fa-brands fa-snapchat" style="color: #FFFC00; -webkit-text-stroke: 1px black;"></i> Snapchat
                </div>
            </div>
        </div>

        <div id="manualChannelInput" class="hidden">
            <div class="form-group">
                <label>Channel Name / Handle</label>
                <input type="text" id="connectChannelName" class="form-input" placeholder="@handle">
                <small style="color:#666">Enter your handle to link this account.</small>
            </div>
        </div>

        <div class="modal-actions" style="margin-top: 20px; text-align: right;">
            <button class="btn btn-text" onclick="document.getElementById('connectChannelModal').classList.add('hidden')">Cancel</button>
            <button id="btnConnect" class="btn btn-primary" onclick="submitConnectChannel()">Connect</button>
        </div>
    </div>
</div>

<!-- Preview Modal (Library) -->
<div id="previewModal" class="modal-overlay hidden">
    <div class="modal-box" style="width: 800px; max-width: 95vw; background: black; padding: 0;">
        <div style="position:relative; width:100%; aspect-ratio:16/9;">
            <video id="mainPreviewVideo" controls autoplay style="width:100%; height:100%; display:block;"></video>
            <button onclick="document.getElementById('previewModal').classList.add('hidden'); document.getElementById('mainPreviewVideo').pause();" style="position:absolute; top:10px; right:10px; background:rgba(0,0,0,0.5); border:none; color:white; border-radius:50%; width:32px; height:32px; cursor:pointer;">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
    </div>
</div>

<!-- Destination Choice Modal -->
<div id="destChoiceModal" class="modal-overlay hidden">
    <div class="modal-box" style="width: 550px;">
        <div class="modal-header" style="border:none; padding-bottom: 5px;">
            <h2 style="font-size: 1.2rem;">Login to YouTube or setup stream manually</h2>
            <button onclick="document.getElementById('destChoiceModal').classList.add('hidden')" class="btn-close"><i class="fa-solid fa-xmark"></i></button>
        </div>

        <div style="padding: 10px 0;">
            <!-- Dynamic Channel List Container -->
            <div id="ytChannelList">
                <!-- Populated via JS -->
            </div>

            <div id="defaultYtFetchOption" onclick="connectYouTubeDestination()" class="queue-item hidden" style="cursor: pointer; border: 2px solid var(--primary); background: #f0f7ff; margin-bottom: 15px;">
                <div style="background: white; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                    <i class="fa-brands fa-youtube" style="color: red; font-size: 1.5rem;"></i>
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: 700; font-size: 1.05rem; display: flex; align-items: center; gap: 10px; color: var(--primary-dark);">
                        Fetch from YouTube
                        <span style="background: var(--success); color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; font-weight: 600;">RECOMMENDED</span>
                    </div>
                    <div style="font-size: 0.9rem; color: var(--text-muted); margin-top: 4px;">Get Stream Key from connected account</div>
                </div>
                <i class="fa-solid fa-chevron-right" style="color: var(--primary);"></i>
            </div>

            <!-- Manual Option -->
            <div onclick="openManualDestinationModal()" class="queue-item" style="cursor: pointer;">
                 <div style="background: #f4f5f7; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;">
                    <i class="fa-solid fa-sliders" style="color: var(--text-muted); font-size: 1.2rem;"></i>
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: 700; font-size: 1.05rem; display: flex; align-items: center; gap: 10px;">
                        Manual setup
                        <span style="background: #eee; color: #666; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; font-weight: 600;">CLASSIC</span>
                    </div>
                    <div style="font-size: 0.9rem; color: var(--text-muted); margin-top: 4px;">Create and enter stream and key manually</div>
                </div>
                 <i class="fa-solid fa-chevron-right" style="color: var(--text-muted);"></i>
            </div>
        </div>
    </div>
</div>

<!-- Add Destination Modal (Manual) -->
<div id="addDestinationModal" class="modal-overlay hidden">
    <div class="modal-box" style="width: 400px;">
        <div class="modal-header" style="padding: 0 0 20px 0; border: none;">
            <h2>Add Destination</h2>
            <button onclick="document.getElementById('addDestinationModal').classList.add('hidden')" class="btn-close"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="form-group">
            <label>Name</label>
            <input type="text" id="newDestName" class="form-input" placeholder="e.g. YouTube Gaming">
        </div>
        <div class="form-group">
            <label>Stream Key</label>
            <div style="position: relative;">
                <input type="password" id="newDestKey" class="form-input" placeholder="rtmp://..." style="padding-right: 40px;">
                <button type="button" onclick="toggleStreamKeyVisibility('newDestKey', this)" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #666; cursor: pointer;">
                    <i class="fa-solid fa-eye"></i>
                </button>
            </div>
        </div>
        <div class="modal-actions" style="margin-top: 20px; text-align: right;">
            <button class="btn btn-text" onclick="document.getElementById('addDestinationModal').classList.add('hidden')">Cancel</button>
            <button class="btn btn-primary" onclick="submitDestination()">Save Destination</button>
        </div>
    </div>
</div>

<!-- Engagement Settings Modal -->
<div id="engagementSettingsModal" class="modal-overlay hidden">
    <div class="modal-box" style="width: 500px;">
        <div class="modal-header" style="border:none;">
            <h2>Engagement Automation</h2>
            <button onclick="document.getElementById('engagementSettingsModal').classList.add('hidden')" class="btn-close"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <p style="color:#666; margin-bottom:20px;">Automatically manage comments using AI (Gemini).</p>

        <div class="form-group" style="display:flex; align-items:center; justify-content:space-between; margin-bottom: 20px;">
            <div>
                <label style="margin:0; font-weight:600;">Auto-Like & Reply Positive</label>
                <div style="font-size:0.85rem; color:#888;">Like positive comments and reply with a smiley.</div>
            </div>
            <label class="switch">
                <input type="checkbox" id="engAutoReply">
                <span class="slider round"></span>
            </label>
        </div>

        <div class="form-group" style="display:flex; align-items:center; justify-content:space-between;">
            <div>
                <label style="margin:0; font-weight:600;">Delete Negative Comments</label>
                <div style="font-size:0.85rem; color:#888;">Automatically remove hate speech or negative sentiment.</div>
            </div>
            <label class="switch">
                <input type="checkbox" id="engDeleteNegative">
                <span class="slider round"></span>
            </label>
        </div>

        <div class="modal-actions" style="text-align:right; margin-top:30px;">
            <button class="btn btn-primary" onclick="saveEngagementSettings()">Save Changes</button>
        </div>
    </div>
</div>

<!-- Internal Payment Modal -->
<div id="paymentModal" class="modal-overlay hidden">
    <div class="modal-box" style="width: 400px; text-align: center;">
        <h2>Confirm Subscription</h2>
        <p id="paymentPlanName" style="margin: 10px 0; font-size: 1.1rem; color: var(--primary);">Upgrade Plan</p>
        <div style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 8px; text-align: left;">
            <div style="display:flex; justify-content:space-between; margin-bottom: 10px;">
                <span>Total due today:</span>
                <strong id="paymentAmount">$0.00</strong>
            </div>
            <div style="font-size: 0.9rem; color: #666;">
                <i class="fa-solid fa-credit-card"></i> **** **** **** 4242
            </div>
        </div>
        <button id="btnConfirmPayment" class="btn btn-primary btn-block btn-lg" onclick="processPayment()">Pay & Upgrade</button>
        <button class="btn btn-text" onclick="document.getElementById('paymentModal').classList.add('hidden')" style="margin-top: 10px;">Cancel</button>
    </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmationModal" class="modal-overlay hidden">
    <div class="modal-box" style="width: 350px; text-align: center;">
        <i class="fa-solid fa-circle-exclamation" style="font-size: 3rem; color: #ffab00; margin-bottom: 15px;"></i>
        <h3 id="confirmTitle" style="margin: 0 0 10px 0;">Are you sure?</h3>
        <p id="confirmMessage" style="color: #666; font-size: 0.95rem; margin-bottom: 25px;">This action cannot be undone.</p>
        <div style="display: flex; gap: 10px; justify-content: center;">
            <button class="btn btn-outline" onclick="closeConfirmModal()">Cancel</button>
            <button id="btnConfirmAction" class="btn btn-danger">Confirm</button>
        </div>
    </div>
</div>

<!-- Support Modal -->
<div id="supportModal" class="modal-overlay hidden">
    <div class="modal-box" style="width: 400px;">
        <div class="modal-header" style="border:none;">
            <h2>Contact Support</h2>
            <button onclick="document.getElementById('supportModal').classList.add('hidden')" class="btn-close"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <p>Need help? Our team is available 24/7.</p>
        <div style="background: #f4f6f8; padding: 15px; border-radius: 6px; margin: 20px 0;">
            <div style="margin-bottom: 10px;"><i class="fa-solid fa-envelope"></i> <b>Email:</b> support@afklive.com</div>
            <div><i class="fa-solid fa-book"></i> <b>Docs:</b> docs.afklive.com</div>
        </div>
        <button class="btn btn-primary btn-block" onclick="document.getElementById('supportModal').classList.add('hidden')">Close</button>
    </div>
</div>

<!-- Schedule Modal -->
<div id="scheduleModal" class="modal-overlay hidden">
    <div class="modal-composer">
        <div class="modal-header">
            <h2>Create Post</h2>
            <button onclick="closeScheduleModal()" class="btn-close"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="modal-body">
            <div class="composer-grid">
                <div class="composer-main">
                    <!-- Step 1: Channel -->
                    <div class="form-group">
                        <label>Post to</label>
                        <div id="modalChannelSelector" class="channel-selector-row"></div>
                    </div>

                    <!-- Step 2: Content -->
                    <div class="form-group">
                        <textarea id="scheduleDescription" class="composer-textarea" placeholder="What would you like to share?"></textarea>
                        <div class="composer-tools">
                             <button class="tool-btn" onclick="aiGenerate('description')" title="AI Assist"><i class="fa-solid fa-wand-magic-sparkles"></i> AI Write</button>
                             <button class="tool-btn" onclick="document.getElementById('scheduleTags').focus()"><i class="fa-solid fa-hashtag"></i> Tags</button>
                        </div>
                    </div>

                    <div class="media-upload-area" id="dropZone">
                        <div id="mediaPlaceholder">
                            <i class="fa-regular fa-image"></i>
                            <span>Add Video</span>
                        </div>
                        <div id="selectedFileDisplay" class="hidden">
                            <i class="fa-solid fa-file-video"></i> <span id="fileName">video.mp4</span>
                        </div>
                        <input type="file" id="scheduleFile" accept="video/*" hidden>
                    </div>

                    <!-- Thumbnail Tools -->
                    <div id="thumbnailTools" class="hidden" style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px; display: flex; align-items: center; justify-content: space-between;">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <div id="thumbPreview" style="width: 60px; height: 34px; background: #ddd; border-radius: 4px; overflow: hidden; display: flex; align-items: center; justify-content: center;">
                                <i class="fa-regular fa-image"></i>
                            </div>
                            <span style="font-size: 0.9rem; font-weight: 500;">Thumbnail</span>
                        </div>
                        <div style="display:flex; gap:10px;">
                            <button class="btn btn-sm btn-outline" onclick="extractFrame()" title="Extract from Video"><i class="fa-solid fa-camera"></i> Auto</button>
                            <a href="https://www.canva.com/create/youtube-thumbnails/" target="_blank" class="btn btn-sm btn-outline" style="color: #5d26c9; border-color: #5d26c9;"><i class="fa-solid fa-wand-magic-sparkles"></i> Canva</a>
                            <button class="btn btn-sm btn-outline" onclick="document.getElementById('scheduleThumbnail').click()"><i class="fa-solid fa-upload"></i> Upload</button>
                        </div>
                        <input type="file" id="scheduleThumbnail" accept="image/*" hidden>
                    </div>

                    <!-- Hidden Video for Extraction -->
                    <video id="frameExtractorVideo" style="display: none;" crossorigin="anonymous"></video>

                    <!-- Progress -->
                    <div id="uploadProgressContainer" class="hidden">
                        <div class="progress-track"><div id="uploadProgressBar" class="progress-fill"></div></div>
                        <small id="uploadPercent">0%</small>
                    </div>

                    <!-- Details -->
                     <div class="form-row">
                        <div class="form-group">
                            <label>Title</label>
                            <input type="text" id="scheduleTitle" class="form-input">
                        </div>
                         <div class="form-group">
                            <label>Time</label>
                            <input type="datetime-local" id="scheduleTime" class="form-input">
                        </div>
                    </div>

                    <div class="collapsible-details">
                         <div class="form-row">
                             <div class="form-group">
                                <label>Category</label>
                                <select id="scheduleCategory" class="form-input"></select>
                             </div>
                             <div class="form-group">
                                <label>Privacy</label>
                                <select id="schedulePrivacy" class="form-input">
                                    <option value="private">Private</option>
                                    <option value="public">Public</option>
                                </select>
                             </div>
                         </div>
                         <div class="form-group">
                             <input type="text" id="scheduleTags" placeholder="Tags (comma separated)" class="form-input">
                         </div>

                         <div class="form-group">
                            <label>First Comment (Pinned)</label>
                            <textarea id="scheduleFirstComment" class="form-input" rows="2" placeholder="Post a comment immediately after upload..."></textarea>
                         </div>

                         <div style="margin-top:15px; padding-top:15px; border-top:1px solid #eee;">
                            <h4 style="margin:0 0 10px 0; font-size:0.95rem;">Audio & Music</h4>

                            <div style="display:flex; gap:10px; margin-bottom:10px;">
                                <button class="btn btn-sm btn-primary" id="tabAudioUpload" onclick="switchAudioTab('upload')">Upload</button>
                                <button class="btn btn-sm btn-outline" id="tabAudioLib" onclick="switchAudioTab('lib')">Stock Library</button>
                            </div>

                            <!-- Upload Tab -->
                            <div id="audioUploadSection">
                                <div class="form-group">
                                    <label>Backing Track (Optional)</label>
                                    <input type="file" id="scheduleAudio" accept=".mp3,.wav" class="form-control" style="font-size:0.9rem;">
                                </div>
                            </div>

                            <!-- Library Tab -->
                            <div id="audioLibSection" class="hidden">
                                <div id="audioTrackList" class="scroll-list" style="height:150px; border:1px solid #eee; border-radius:4px; margin-bottom:10px;">
                                    Loading...
                                </div>
                                <input type="hidden" id="selectedAudioTrackId">
                                <div id="selectedTrackName" style="font-size:0.85rem; font-weight:600; color:var(--primary);"></div>
                            </div>

                            <div class="form-group">
                                <label>Music Volume (<span id="volVal">50%</span>)</label>
                                <input type="range" id="scheduleAudioVol" min="0" max="200" value="50" style="width:100%" oninput="document.getElementById('volVal').innerText = this.value + '%'">
                                <div style="font-size:0.8rem; color:#888;">100% = Original volume. 200% = Boost.</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="composer-preview">
                    <div class="preview-card">
                        <div class="preview-card-header">
                            <i class="fa-brands fa-youtube" style="color:red"></i>
                            <span style="font-weight:600; font-size:0.9rem;">YouTube Preview</span>
                        </div>
                        <div style="display:flex; justify-content:space-between; align-items:center; padding: 0 10px 5px;">
                            <span style="font-size:0.8rem; color:#666;">Preview Mode:</span>
                            <div class="toggle-group">
                                <button class="btn btn-xs btn-primary" onclick="setPreviewMode('standard')">16:9</button>
                                <button class="btn btn-xs btn-outline" onclick="setPreviewMode('shorts')">9:16</button>
                            </div>
                        </div>

                        <div class="preview-card-image" id="previewImageMock">
                            <i class="fa-solid fa-play"></i>
                            <!-- Safe Zone Overlay for Shorts -->
                            <div id="shortsSafeZone" class="hidden" style="position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none;">
                                <div style="position:absolute; bottom:120px; right:10px; display:flex; flex-direction:column; gap:15px; color:rgba(255,255,255,0.7); align-items:center;">
                                    <i class="fa-solid fa-thumbs-up fa-lg"></i>
                                    <i class="fa-solid fa-comment-dots fa-lg"></i>
                                    <i class="fa-solid fa-share fa-lg"></i>
                                </div>
                                <div style="position:absolute; bottom:20px; left:10px; color:white; font-size:0.8rem;">
                                    <div style="width:30px; height:30px; background:#ccc; border-radius:50%; margin-bottom:5px;"></div>
                                    Channel Name
                                </div>
                            </div>
                        </div>
                        <div class="preview-card-body">
                            <h4 id="previewTitleMock" style="margin:0 0 5px 0; font-size:0.95rem;">Video Title</h4>
                            <div id="previewDescMock" style="font-size:0.85rem; color:#666; line-height:1.4;">
                                Description will appear here...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" id="btnSchedule" onclick="submitSchedule()">Schedule Post</button>
        </div>
    </div>
</div>

<!-- Auto Schedule Modal -->
<div id="autoScheduleModal" class="modal-overlay hidden">
    <div class="modal-box">
        <h3>Auto Schedule</h3>
        <p>Automatically distribute your library content.</p>
        <div class="form-group">
            <label>Start Date</label>
            <input type="date" id="autoStartDate" class="form-input">
        </div>
        <div class="form-group">
            <label>Times (HH:mm)</label>
            <input type="text" id="autoTimeSlots" placeholder="10:00, 15:00" class="form-input">
        </div>

        <div style="border-top:1px solid #eee; margin: 15px 0; padding-top:15px;">
            <h4 style="margin: 0 0 10px 0;">AI Enhancement</h4>
            <div class="form-group">
                <label>Base Topic (Optional)</label>
                <input type="text" id="autoTopic" placeholder="e.g. Minecraft Gameplay" class="form-input">
            </div>
            <div class="form-group" style="display:flex; align-items:center; gap:10px;">
                <input type="checkbox" id="autoUseAi">
                <label for="autoUseAi" style="margin:0; font-weight:400;">Generate Titles, Descriptions & Tags with AI</label>
            </div>
        </div>

        <div class="modal-actions">
            <button class="btn btn-primary" onclick="submitAutoSchedule()">Apply</button>
            <button class="btn btn-text" onclick="document.getElementById('autoScheduleModal').classList.add('hidden')">Cancel</button>
        </div>
    </div>
</div>

<!-- Stream Library Modal -->
<div id="streamLibraryModal" class="modal-overlay hidden">
    <div class="modal-box" style="width: 500px;">
        <div class="modal-header" style="border:none; padding-bottom: 10px;">
            <h2>Select Video</h2>
            <button onclick="document.getElementById('streamLibraryModal').classList.add('hidden')" class="btn-close"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div id="streamLibraryList" class="scroll-list" style="height: 300px; padding: 0;"></div>
    </div>
</div>

<!-- YouTube Import Modal -->
<div id="youtubeImportModal" class="modal-overlay hidden">
    <div class="modal-box" style="width: 450px;">
        <div class="modal-header" style="border:none; padding-bottom: 10px;">
            <h2>Import from YouTube</h2>
            <button onclick="document.getElementById('youtubeImportModal').classList.add('hidden')" class="btn-close"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="form-group">
            <label>Video URL</label>
            <input type="text" id="ytImportUrl" class="form-input" placeholder="https://youtube.com/watch?v=...">
            <small style="color:#666;">Video will be downloaded to your library.</small>
        </div>
        <div class="modal-actions" style="margin-top: 20px; text-align: right;">
            <button class="btn btn-text" onclick="document.getElementById('youtubeImportModal').classList.add('hidden')">Cancel</button>
            <button class="btn btn-primary" onclick="submitYouTubeImport()">Import</button>
        </div>
    </div>
</div>

<!-- Scheduled Streams List Modal -->
<div id="scheduledStreamsModal" class="modal-overlay hidden">
    <div class="modal-box" style="width: 600px;">
        <div class="modal-header" style="border:none; padding-bottom: 10px;">
            <h2>Scheduled Streams</h2>
            <button onclick="document.getElementById('scheduledStreamsModal').classList.add('hidden')" class="btn-close"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div id="scheduledStreamsList" class="scroll-list" style="max-height: 400px; overflow-y:auto; padding: 0;">
            Loading...
        </div>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="js/toast.js"></script>
<script src="js/app.js"></script>
</body>
</html>
