<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AFK Live</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="css/theme.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üî¥</text></svg>">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2c68f6',
                        'primary-dark': '#1b53d6',
                        danger: '#e02424',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
</head>
<body>

<!-- Mobile Sidebar Overlay -->
<div id="sidebarOverlay" class="sidebar-overlay" onclick="toggleMobileMenu()"></div>

<div class="app-layout">

    <!-- LEVEL 1: ICON SIDEBAR (Channels/Orgs) -->
    <aside class="icon-sidebar">
        <a href="#" class="icon-btn logo-btn" title="AFK Live">üî¥</a>

        <div id="channelIconsList" class="channel-list">
            <!-- Populated via JS -->
        </div>

        <button class="icon-btn add-btn" onclick="openConnectModal()" title="Add Channel">
            <i class="fa-solid fa-plus"></i>
        </button>

        <div class="spacer"></div>

        <a href="#" class="icon-btn" onclick="switchView('settings')" title="Settings">
            <img src="" id="userAvatarSmall" class="avatar-small hidden">
            <i class="fa-solid fa-gear" id="settingsIcon"></i>
        </a>
    </aside>

    <!-- LEVEL 2: NAV SIDEBAR (Contextual) -->
    <nav class="sub-sidebar" id="subSidebar">
        <div class="sidebar-header">
            <h2 id="sidebarTitle">Publishing</h2>
            <div class="dropdown-trigger" onclick="toggleChannelDropdown()">
                 <span id="currentChannelName">All Channels</span> <i class="fa-solid fa-chevron-down"></i>
            </div>
            <!-- Dropdown Menu -->
            <div id="channelDropdownMenu" class="dropdown-menu">
                <!-- Populated via JS -->
            </div>
        </div>

        <div class="menu">
            <a href="#" class="menu-item active" data-target="view-publish" onclick="switchView('publish')">
                <i class="fa-regular fa-paper-plane"></i>
                <span>Queue</span>
            </a>
            <a href="#" class="menu-item" data-target="view-calendar" onclick="switchView('calendar')">
                <i class="fa-regular fa-calendar"></i>
                <span>Calendar</span>
            </a>
            <div class="menu-divider"></div>
            <a href="#" class="menu-item" data-target="view-stream" onclick="switchView('stream')">
                <i class="fa-solid fa-satellite-dish"></i>
                <span>Live Studio</span>
            </a>
             <a href="#" class="menu-item" data-target="view-community" onclick="switchView('community')">
                <i class="fa-regular fa-comments"></i>
                <span>Engagement</span>
            </a>
            <a href="#" class="menu-item" data-target="view-analytics" onclick="switchView('analytics')">
                <i class="fa-solid fa-chart-line"></i>
                <span>Analytics</span>
            </a>
            <a href="#" class="menu-item" data-target="view-library" onclick="switchView('library')">
                <i class="fa-regular fa-folder"></i>
                <span>Media Library</span>
            </a>
            <div class="menu-divider"></div>
             <a href="#" class="menu-item" data-target="view-settings" onclick="switchView('settings')">
                <i class="fa-solid fa-gear"></i>
                <span>Settings</span>
            </a>
        </div>

        <div class="sidebar-footer">
             <a href="#" class="menu-item" onclick="openSupportModal()">
                <i class="fa-regular fa-life-ring"></i>
                <span>Support</span>
            </a>
             <a href="/logout" class="menu-item logout">
                <i class="fa-solid fa-right-from-bracket"></i>
                <span>Logout</span>
            </a>
        </div>
    </nav>

    <!-- LEVEL 3: CONTENT -->
    <main class="content-area">

        <!-- Mobile Header -->
        <header class="mobile-header">
            <button class="hamburger" onclick="toggleMobileMenu()"><i class="fa-solid fa-bars"></i></button>
            <span class="mobile-title">AFK Live</span>
        </header>

        <div id="verificationBanner" class="hidden warning-banner">
            ‚ö†Ô∏è Please verify your email address to access all features.
        </div>

        <!-- VIEW: PUBLISH -->
        <div id="view-publish" class="view-section">
            <header class="page-header">
                <h1>Queue</h1>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="showScheduleModal()">
                        <i class="fa-solid fa-pen-to-square"></i> Create Post
                    </button>
                </div>
            </header>

            <div class="container-fluid">
                <div class="queue-list" id="queueList">
                     <!-- Populated JS -->
                </div>
            </div>
        </div>

        <!-- VIEW: STREAM (Alpine & Tailwind - Apple Style) -->
        <div id="view-stream" class="view-section hidden h-full p-0 overflow-hidden bg-gray-50 font-sans" x-data="streamStudio">
            <div class="flex flex-col lg:flex-row h-full w-full">

                <!-- LEFT: STAGE -->
                <div class="flex-1 flex flex-col relative overflow-hidden bg-gray-100 lg:bg-transparent">
                    <!-- Header / Top Bar -->
                    <div class="h-16 flex items-center justify-between px-8 z-10">
                        <div class="flex items-center gap-3">
                            <span class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Studio</span>
                            <span x-show="isLive" class="bg-red-50 text-red-600 border border-red-100 px-2 py-0.5 rounded text-xs font-bold animate-pulse flex items-center gap-1">
                                <span class="w-1.5 h-1.5 rounded-full bg-red-600"></span> LIVE
                            </span>
                        </div>
                    </div>

                    <!-- Main Preview Area -->
                    <div class="flex-1 flex items-center justify-center p-4 lg:p-8 lg:pb-32 min-h-[300px]">
                        <div class="relative w-full max-w-4xl aspect-video bg-black rounded-2xl shadow-2xl overflow-hidden ring-1 ring-black/5 group">
                            <!-- Placeholder -->
                            <div x-show="!selectedVideo" class="absolute inset-0 flex flex-col items-center justify-center text-gray-500">
                                <i class="fa-solid fa-film text-4xl lg:text-6xl mb-4 opacity-20"></i>
                                <p class="font-medium text-sm lg:text-lg">No Source Selected</p>
                                <button @click="openSourceSelector()" class="mt-4 px-4 py-2 text-sm lg:px-5 lg:py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-full font-medium transition shadow-lg shadow-blue-600/20">
                                    Select Video
                                </button>
                            </div>

                            <!-- Video Player -->
                            <video id="previewPlayer" class="w-full h-full object-contain" x-show="selectedVideo" controls playsinline></video>

                            <!-- Title Overlay (On Hover) -->
                            <div x-show="selectedVideo" class="absolute top-0 left-0 w-full p-6 bg-gradient-to-b from-black/60 to-transparent opacity-0 group-hover:opacity-100 transition duration-300 pointer-events-none hidden lg:block">
                                <h3 class="text-white font-medium text-lg" x-text="selectedVideo?.title"></h3>
                            </div>
                        </div>
                    </div>

                    <!-- Floating Control Dock -->
                    <div class="absolute bottom-4 lg:bottom-8 left-1/2 -translate-x-1/2 z-20 w-full max-w-[90%] lg:w-auto">
                        <div class="bg-white/80 backdrop-blur-xl border border-white/40 shadow-xl shadow-gray-200/50 rounded-2xl p-2 flex items-center gap-2 ring-1 ring-gray-900/5">

                            <!-- Source Select -->
                            <button @click="openSourceSelector()" class="p-3 rounded-xl hover:bg-gray-100 text-gray-600 hover:text-gray-900 transition tooltip-trigger relative group">
                                <i class="fa-solid fa-folder-open text-xl"></i>
                                <span class="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 bg-gray-900 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition whitespace-nowrap pointer-events-none">Source</span>
                            </button>

                            <div class="w-px h-8 bg-gray-200 mx-1"></div>

                            <!-- Mute -->
                            <button @click="muteOriginal = !muteOriginal" :class="muteOriginal ? 'bg-blue-50 text-blue-600' : 'text-gray-500 hover:bg-gray-100'" class="p-3 rounded-xl transition relative group">
                                <i class="fa-solid" :class="muteOriginal ? 'fa-volume-xmark' : 'fa-volume-high'"></i>
                            </button>

                            <!-- Loop -->
                            <button @click="loopVideo = !loopVideo" :class="loopVideo ? 'bg-blue-50 text-blue-600' : 'text-gray-500 hover:bg-gray-100'" class="p-3 rounded-xl transition relative group">
                                <i class="fa-solid fa-repeat"></i>
                            </button>

                            <div class="w-px h-8 bg-gray-200 mx-1"></div>

                            <!-- Main Action -->
                            <button @click="startStream()" x-show="!isLive" :disabled="isBusy"
                                class="px-6 py-3 rounded-xl font-bold text-white shadow-lg transition transform active:scale-95 flex items-center gap-2 min-w-[140px] justify-center bg-red-600 hover:bg-red-700 shadow-red-500/30">
                                <i x-show="isBusy" class="fa-solid fa-spinner fa-spin"></i>
                                <span x-show="!isBusy">Go Live</span>
                            </button>

                             <button @click="stopStream()" x-show="isLive" :disabled="isBusy"
                                class="px-6 py-3 rounded-xl font-bold text-white shadow-lg transition transform active:scale-95 flex items-center gap-2 min-w-[140px] justify-center bg-gray-800 hover:bg-gray-900">
                                <i x-show="isBusy" class="fa-solid fa-spinner fa-spin"></i>
                                <span x-show="!isBusy">End Stream</span>
                            </button>

                        </div>
                    </div>

                     <!-- Modal: Source Selector (Tailwind) -->
                    <div x-show="showLibraryModal" class="absolute inset-0 z-50 bg-gray-900/20 backdrop-blur-sm flex items-center justify-center p-8" x-transition.opacity style="display:none;">
                        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-full flex flex-col overflow-hidden ring-1 ring-gray-900/5">
                            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                                <h3 class="font-semibold text-gray-900">Select Source</h3>
                                <div class="flex items-center gap-3">
                                    <button class="text-sm text-blue-600 font-medium hover:bg-blue-50 px-3 py-1.5 rounded-lg transition" onclick="document.getElementById('studioVideoUpload').click()">
                                        <i class="fa-solid fa-cloud-arrow-up mr-1"></i> Upload
                                    </button>
                                    <input type="file" id="studioVideoUpload" hidden accept="video/*" @change="handleVideoUpload($event)">
                                    <button @click="showLibraryModal = false" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
                                </div>
                            </div>
                            <div class="flex-1 overflow-y-auto p-4 space-y-2">
                                <template x-if="isLoadingLibrary">
                                    <div class="text-center py-8 text-gray-500"><i class="fa-solid fa-spinner fa-spin"></i> Loading library...</div>
                                </template>
                                <template x-for="video in libraryVideos" :key="video.id">
                                    <div @click="selectVideo(video)" class="flex items-center gap-4 p-3 rounded-xl hover:bg-blue-50 cursor-pointer group transition border border-transparent hover:border-blue-100">
                                        <div class="w-16 h-10 bg-gray-200 rounded-lg overflow-hidden relative">
                                             <!-- If thumbnail exists -->
                                             <img x-show="video.thumbnailS3Key" :src="`/api/videos/${video.id}/thumbnail`" class="w-full h-full object-cover">
                                             <div x-show="!video.thumbnailS3Key" class="absolute inset-0 flex items-center justify-center text-gray-400"><i class="fa-solid fa-film"></i></div>
                                        </div>
                                        <div class="flex-1">
                                            <h4 class="font-medium text-gray-900 text-sm group-hover:text-blue-700" x-text="video.title"></h4>
                                            <div class="flex items-center gap-2 mt-1">
                                                 <span class="text-xs text-gray-500" x-text="(video.fileSize / 1024 / 1024).toFixed(1) + ' MB'"></span>
                                                 <span x-show="video.optimizationStatus === 'COMPLETED'" class="text-[10px] font-bold bg-green-100 text-green-700 px-1.5 py-0.5 rounded">OPTIMIZED</span>
                                            </div>
                                        </div>
                                        <i class="fa-solid fa-chevron-right text-gray-300 group-hover:text-blue-500"></i>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- RIGHT: SIDEBAR -->
                <div class="w-full lg:w-96 bg-white border-t lg:border-t-0 lg:border-l border-gray-200 flex flex-col shadow-xl shadow-gray-200/50 z-30 h-1/2 lg:h-full">

                    <!-- Tabs -->
                    <div class="p-4 pb-0">
                        <div class="flex p-1 bg-gray-100 rounded-lg overflow-x-auto">
                            <template x-for="tab in ['setup', 'audio', 'brand', 'streams']">
                                <button @click="switchTab(tab)"
                                    class="flex-1 py-1.5 text-xs font-semibold rounded-md transition capitalize whitespace-nowrap px-2"
                                    :class="activeTab === tab ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-500 hover:text-gray-700'"
                                    x-text="tab === 'setup' ? 'Setup' : tab">
                                </button>
                            </template>
                        </div>
                    </div>

                    <!-- Content -->
                    <div class="flex-1 overflow-y-auto p-5">

                        <!-- SETUP TAB -->
                        <div x-show="activeTab === 'setup'" class="space-y-6">
                            <!-- Destinations -->
                            <section>
                                <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Destinations</h4>
                                <div class="space-y-2">
                                     <template x-for="dest in destinations" :key="dest.id">
                                         <div @click="toggleDest(dest.id)" class="flex items-center gap-3 p-3 rounded-xl border cursor-pointer transition"
                                             :class="dest.selected ? 'bg-blue-50 border-blue-200' : 'bg-white border-gray-200 hover:border-gray-300'">
                                             <div class="w-5 h-5 rounded-full border flex items-center justify-center"
                                                 :class="dest.selected ? 'bg-blue-600 border-blue-600' : 'border-gray-300 bg-white'">
                                                 <i x-show="dest.selected" class="fa-solid fa-check text-white text-xs"></i>
                                             </div>
                                             <div class="flex-1">
                                                 <div class="text-sm font-medium text-gray-900" x-text="dest.name"></div>
                                             </div>
                                             <i x-show="dest.type === 'youtube_auto'" class="fa-brands fa-youtube text-red-600"></i>
                                         </div>
                                     </template>
                                </div>
                                <button @click="window.openAddDestinationChoiceModal()" class="mt-3 w-full py-2 text-sm text-blue-600 font-medium bg-blue-50 rounded-lg hover:bg-blue-100 transition">
                                    + Add Destination
                                </button>
                            </section>

                            <!-- Broadcast Info -->
                            <section>
                                <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Broadcast Info</h4>
                                <div class="space-y-3">
                                    <div>
                                        <div class="flex justify-between mb-1">
                                            <label class="block text-xs font-medium text-gray-700">Title</label>
                                            <button id="ai-btn-title" @click="generateMetadata('title')" class="text-xs text-blue-600 hover:text-blue-700 flex items-center gap-1"><i class="fa-solid fa-wand-magic-sparkles"></i> AI Magic</button>
                                        </div>
                                        <input type="text" x-model="streamTitle" class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition" placeholder="Stream Title">
                                    </div>
                                    <div>
                                        <div class="flex justify-between mb-1">
                                            <label class="block text-xs font-medium text-gray-700">Description</label>
                                            <button id="ai-btn-desc" @click="generateMetadata('desc')" class="text-xs text-blue-600 hover:text-blue-700 flex items-center gap-1"><i class="fa-solid fa-wand-magic-sparkles"></i> AI Magic</button>
                                        </div>
                                        <textarea x-model="streamDescription" rows="3" class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition" placeholder="Description"></textarea>
                                    </div>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">Privacy</label>
                                            <select x-model="streamPrivacy" class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm">
                                                <option value="public">Public</option>
                                                <option value="unlisted">Unlisted</option>
                                                <option value="private">Private</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">Quality</label>
                                            <select x-model="streamQuality" class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm">
                                                <option value="1080">1080p</option>
                                                <option value="720">720p</option>
                                                <option value="2160">4K</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </section>
                        </div>

                        <!-- STREAMS TAB -->
                        <div x-show="activeTab === 'streams'" class="space-y-4">
                            <div x-show="activeStreams.length === 0" class="text-center py-12">
                                <div class="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-3 text-gray-300">
                                    <i class="fa-solid fa-tower-broadcast text-2xl"></i>
                                </div>
                                <p class="text-gray-500 text-sm">No active streams</p>
                            </div>

                            <template x-for="stream in activeStreams" :key="stream.id">
                                <div class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm hover:shadow-md transition group">
                                    <div class="flex items-start gap-3">
                                        <div class="w-10 h-10 rounded-full bg-red-50 text-red-600 flex items-center justify-center shrink-0">
                                            <i class="fa-solid fa-satellite-dish animate-pulse"></i>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <h4 class="font-semibold text-sm text-gray-900 truncate" x-text="stream.title || 'Live Stream'"></h4>
                                            <p class="text-xs text-gray-500 mt-0.5" x-text="formatDuration(stream.startTime)"></p>
                                            <div class="mt-3 flex items-center gap-2">
                                                <button @click="stopStream(stream.id)" class="px-3 py-1.5 bg-red-50 text-red-600 rounded-lg text-xs font-medium hover:bg-red-100 transition flex items-center gap-1">
                                                    <i class="fa-solid fa-stop"></i> End
                                                </button>
                                                <button @click="setEndTime(stream.id)" class="px-3 py-1.5 bg-gray-50 text-gray-600 rounded-lg text-xs font-medium hover:bg-gray-100 transition flex items-center gap-1" title="Set End Time">
                                                    <i class="fa-regular fa-clock"></i> Stop At
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <!-- AUDIO TAB -->
                        <div x-show="activeTab === 'audio'" class="space-y-6">
                            <section>
                                 <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Audio & Music</h4>

                                 <!-- Audio Sub-Tabs -->
                                 <div class="flex gap-2 mb-4">
                                     <button @click="audioTab = 'upload'" class="px-3 py-1 text-xs rounded-full border transition" :class="audioTab === 'upload' ? 'bg-gray-900 text-white border-gray-900' : 'text-gray-600 border-gray-200'">Upload</button>
                                     <button @click="audioTab = 'lib'" class="px-3 py-1 text-xs rounded-full border transition" :class="audioTab === 'lib' ? 'bg-gray-900 text-white border-gray-900' : 'text-gray-600 border-gray-200'">Stock</button>
                                     <button @click="audioTab = 'mylib'" class="px-3 py-1 text-xs rounded-full border transition" :class="audioTab === 'mylib' ? 'bg-gray-900 text-white border-gray-900' : 'text-gray-600 border-gray-200'">My Library</button>
                                 </div>

                                 <!-- Upload -->
                                 <div x-show="audioTab === 'upload'">
                                     <div class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center hover:bg-gray-50 transition cursor-pointer relative">
                                         <input type="file" class="absolute inset-0 opacity-0 cursor-pointer" accept=".mp3,.wav" @change="handleMusicUpload($event)">
                                         <i class="fa-solid fa-cloud-arrow-up text-gray-400 text-2xl mb-2"></i>
                                         <p class="text-xs text-gray-500" x-text="uploadedMusicName || 'Click to upload mp3'"></p>
                                     </div>
                                 </div>

                                 <!-- Stock -->
                                 <div x-show="audioTab === 'lib'" class="space-y-2 max-h-60 overflow-y-auto">
                                     <template x-for="track in stockTracks" :key="track.id">
                                         <div @click="selectedStockId = track.id" class="flex items-center justify-between p-2 rounded-lg cursor-pointer hover:bg-gray-50"
                                             :class="selectedStockId === track.id ? 'bg-blue-50' : ''">
                                             <div class="flex items-center gap-2 overflow-hidden">
                                                 <i class="fa-solid fa-music text-gray-400 text-xs"></i>
                                                 <span class="text-xs font-medium truncate" x-text="track.title"></span>
                                             </div>
                                             <button @click.stop="previewAudio(track.url)" class="w-6 h-6 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 text-xs">
                                                 <i class="fa-solid" :class="playingUrl === track.url ? 'fa-pause' : 'fa-play'"></i>
                                             </button>
                                         </div>
                                     </template>
                                 </div>

                                 <!-- My Library -->
                                 <div x-show="audioTab === 'mylib'" class="space-y-2 max-h-60 overflow-y-auto">
                                     <template x-for="track in libraryTracks" :key="track.id">
                                         <div @click="selectedLibraryMusicName = track.title" class="flex items-center justify-between p-2 rounded-lg cursor-pointer hover:bg-gray-50"
                                             :class="selectedLibraryMusicName === track.title ? 'bg-blue-50' : ''">
                                             <div class="flex items-center gap-2 overflow-hidden">
                                                 <i class="fa-solid fa-file-audio text-gray-400 text-xs"></i>
                                                 <span class="text-xs font-medium truncate" x-text="track.title"></span>
                                             </div>
                                             <button @click.stop="previewAudio('/api/library/stream/' + track.id)" class="w-6 h-6 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 text-xs">
                                                 <i class="fa-solid" :class="playingUrl === '/api/library/stream/' + track.id ? 'fa-pause' : 'fa-play'"></i>
                                             </button>
                                         </div>
                                     </template>
                                 </div>

                                 <!-- Volume -->
                                 <div class="mt-4">
                                     <div class="flex justify-between text-xs mb-2 text-gray-600">
                                         <span>Music Volume</span>
                                         <span x-text="musicVolume + '%'"></span>
                                     </div>
                                     <input type="range" x-model="musicVolume" min="0" max="100" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                                 </div>

                            </section>
                        </div>

                        <!-- BRAND TAB -->
                        <div x-show="activeTab === 'brand'" class="space-y-6">
                            <section>
                                <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Branding</h4>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-2">Watermark / Logo</label>
                                    <div class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center hover:bg-gray-50 transition cursor-pointer relative">
                                         <input type="file" id="streamWatermarkFile" class="absolute inset-0 opacity-0 cursor-pointer" accept=".png,.jpg" onchange="window.handleWatermarkUpload(this)">
                                         <i class="fa-solid fa-image text-gray-400 text-2xl mb-2"></i>
                                         <p class="text-xs text-gray-500">Upload PNG/JPG</p>
                                    </div>
                                    <div id="watermarkPreview" class="hidden mt-3 p-2 bg-blue-50 rounded-lg flex items-center justify-between">
                                        <img id="watermarkImg" src="" class="h-8 object-contain">
                                        <button onclick="window.clearWatermark()" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-xmark"></i></button>
                                    </div>
                                </div>
                            </section>
                        </div>


                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: CALENDAR -->
        <div id="view-calendar" class="view-section hidden">
            <header class="page-header">
                <h1>Calendar</h1>
            </header>
            <div id="calendar" class="calendar-container"></div>
        </div>

        <!-- VIEW: COMMUNITY -->
        <div id="view-community" class="view-section hidden" style="padding: 20px;">
            <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                 <h2 style="margin:0;">Engagement</h2>
                 <button class="btn btn-outline btn-sm" onclick="showEngagementSettings()"><i class="fa-solid fa-robot"></i> AI Automation</button>
            </div>

            <div class="community-grid-layout flex flex-col lg:grid lg:grid-cols-[240px_350px_1fr]">
                <!-- SIDEBAR -->
                <div class="comm-sidebar hidden lg:block">
                    <div class="comm-nav-item active" onclick="filterCommTab('all')">
                        <i class="fa-solid fa-inbox"></i> All Comments
                    </div>
                    <div class="comm-nav-item" onclick="filterCommTab('unreplied')">
                        <i class="fa-regular fa-envelope-open"></i> Unreplied
                    </div>
                    <div style="margin: 15px 20px 5px; font-size: 0.75rem; font-weight: 700; color: #999; text-transform: uppercase;">Activity</div>
                    <div class="comm-nav-item" onclick="filterCommTab('activity')">
                        <i class="fa-solid fa-bolt"></i> Auto-Actions
                    </div>
                </div>

                <!-- LIST -->
                <div id="commListPanel" class="comm-list-panel h-full overflow-y-auto border-b lg:border-b-0 lg:border-r border-gray-200">
                     <div style="padding: 15px; border-bottom: 1px solid var(--border);">
                         <input type="text" placeholder="Search..." class="form-input" style="font-size: 0.9rem;">
                     </div>
                     <div id="threadList" class="thread-list">
                         <!-- Populated via JS -->
                     </div>
                </div>

                <!-- ACTIVITY VIEW (Alternative to List/Detail) -->
                <div id="commActivityView" class="comm-detail-panel hidden" style="padding: 30px; overflow-y: auto; grid-column: span 2;">
                    <h3 style="margin-top:0;">Automation Log</h3>
                    <div id="activityList" class="activity-list"></div>
                </div>

                <!-- DETAIL -->
                <div id="commDetailView" class="comm-detail-panel">
                    <div id="emptyThreadState" class="empty-state" style="padding-top: 100px;">
                        <i class="fa-regular fa-comments"></i>
                        <p>Select a conversation to reply</p>
                    </div>

                    <div id="activeThread" class="hidden" style="display: flex; flex-direction: column; height: 100%;">
                        <div class="thread-header" style="padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #fafafa;">
                             <div style="font-weight: 600; font-size: 0.95rem; display: flex; align-items: center; gap: 8px;">
                                 <i class="fa-brands fa-youtube" style="color: red;"></i>
                                 <span id="threadVideoTitle">Video Title</span>
                             </div>
                             <a href="#" id="threadVideoLink" target="_blank" style="color: var(--text-muted);"><i class="fa-solid fa-external-link"></i></a>
                        </div>

                        <div id="threadMessages" class="thread-messages" style="flex: 1; overflow-y: auto; padding: 20px;">
                            <!-- Bubbles -->
                        </div>

                        <!-- AI Suggestions Area -->
                        <div id="aiSuggestionsArea" class="hidden" style="padding: 10px 20px; background: #f0f8ff; border-top: 1px solid #cce0ff;">
                            <small style="font-weight:600; color:#0052cc; display:block; margin-bottom:8px;">AI Suggestions:</small>
                            <div id="aiChips" style="display:flex; gap:8px; flex-wrap:wrap;"></div>
                            <button class="btn btn-sm btn-text" onclick="generateSuggestions()" style="font-size:0.8rem; margin-top:5px; padding-left:0;"><i class="fa-solid fa-rotate"></i> Refresh</button>
                        </div>

                        <div class="reply-box" style="padding: 20px; border-top: 1px solid var(--border); background: white;">
                            <textarea id="replyInput" placeholder="Write a reply..." rows="3" class="form-input" style="margin-bottom: 10px;"></textarea>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <button class="btn btn-sm btn-outline" onclick="toggleAiSuggestions()"><i class="fa-solid fa-wand-magic-sparkles" style="color: #8e44ad;"></i> AI Assist</button>
                                <button class="btn btn-primary" onclick="sendReply()">Reply</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: ANALYTICS -->
        <div id="view-analytics" class="view-section hidden">
             <header class="page-header">
                <h1>Analytics</h1>
                <select id="analyticsRange" class="form-select" onchange="initAnalytics()">
                    <option value="7">Last 7 Days</option>
                    <option value="28" selected>Last 28 Days</option>
                    <option value="90">Last 90 Days</option>
                    <option value="365">Last Year</option>
                </select>
            </header>

            <div class="summary-grid">
                 <div class="card summary-card">
                     <h3>Views</h3>
                     <p id="totalViews">0</p>
                 </div>
                 <div class="card summary-card">
                     <h3>Subscribers</h3>
                     <p id="totalSubs">0</p>
                 </div>
                 <div class="card summary-card">
                     <h3>Watch Time</h3>
                     <p id="totalWatchTime">0</p>
                 </div>
             </div>
             <div class="card chart-card">
                 <canvas id="analyticsChart"></canvas>
             </div>
        </div>

        <!-- VIEW: LIBRARY -->
        <div id="view-library" class="view-section hidden">
            <header class="page-header">
                <h1>Media Library</h1>
                <div class="header-actions">
                    <button class="btn btn-outline" onclick="openYouTubeImportModal()"><i class="fa-brands fa-youtube" style="color:red"></i> Import YouTube</button>
                    <button class="btn btn-outline" onclick="document.getElementById('bulkUploadInput').click()">Upload</button>
                    <input type="file" id="bulkUploadInput" multiple hidden accept="video/*,.zip">
                    <button class="btn btn-outline" id="btnDeleteSelected" disabled onclick="deleteSelectedVideos()" style="color: var(--danger); border-color: var(--danger);">Delete Selected</button>
                    <button class="btn btn-outline" id="btnMerge" disabled onclick="mergeSelectedVideos()">Merge Selected</button>
                    <button class="btn btn-primary" onclick="showAutoScheduleModal()">Auto-Schedule</button>
                </div>
            </header>
            <div style="margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between;">
                <label style="display:flex; align-items:center; gap:8px; font-weight:600; cursor:pointer;">
                    <input type="checkbox" id="selectAllLibrary" onchange="toggleSelectAllLibrary(this)">
                    Select All
                </label>
                <div id="libraryPaginationControls" style="display:flex; gap:10px; align-items:center;">
                    <!-- JS populated -->
                </div>
            </div>
            <div id="libraryList" class="queue-list"></div>
        </div>

        <!-- VIEW: SETTINGS (Alpine + Tailwind) -->
        <div id="view-settings" class="view-section hidden bg-gray-50/50" x-data="settingsStudio">
            <div class="max-w-6xl mx-auto h-full flex flex-col">
                <header class="mb-8">
                    <h1 class="text-3xl font-bold text-gray-900 tracking-tight">Settings</h1>
                    <p class="text-gray-500 mt-1">Manage your account, channels, and subscription.</p>
                </header>

                <div class="flex flex-col lg:flex-row gap-8 flex-1 min-h-0">
                    <!-- SIDEBAR NAV -->
                    <nav class="w-full lg:w-64 flex-shrink-0 space-y-1">
                        <template x-for="item in [
                            {id: 'general', icon: 'fa-user', label: 'General'},
                            {id: 'channels', icon: 'fa-share-nodes', label: 'Channels'},
                            {id: 'plans', icon: 'fa-credit-card', label: 'Plan & Billing'}
                        ]">
                            <button @click="switchTab(item.id)"
                                class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium transition-all duration-200"
                                :class="activeTab === item.id ? 'bg-white text-blue-600 shadow-sm ring-1 ring-gray-200' : 'text-gray-600 hover:bg-gray-100 hover:text-gray-900'">
                                <i class="fa-solid w-5 text-center" :class="item.icon"></i>
                                <span x-text="item.label"></span>
                            </button>
                        </template>
                    </nav>

                    <!-- CONTENT AREA -->
                    <div class="flex-1 min-w-0 bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden flex flex-col">

                        <!-- TAB: GENERAL -->
                        <div x-show="activeTab === 'general'" class="p-8 space-y-8 animate-fade-in">
                            <section>
                                <h3 class="text-lg font-semibold text-gray-900 mb-4">Account Information</h3>
                                <div class="bg-gray-50 rounded-xl p-6 border border-gray-100 flex items-center gap-6">
                                    <div class="w-20 h-20 rounded-full bg-gray-200 overflow-hidden ring-4 ring-white shadow-sm">
                                        <img :src="user?.picture" class="w-full h-full object-cover">
                                    </div>
                                    <div class="flex-1">
                                        <div class="text-xl font-bold text-gray-900" x-text="user?.name || 'User'"></div>
                                        <div class="text-sm text-gray-500" x-text="user?.email"></div>
                                        <div class="mt-2 flex items-center gap-2">
                                             <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                                <span x-text="user?.plan?.name || 'Free Plan'"></span>
                                             </span>
                                        </div>
                                    </div>
                                </div>
                            </section>

                            <section>
                                <h3 class="text-lg font-semibold text-gray-900 mb-4">Linked Accounts</h3>
                                <div class="bg-white border border-gray-200 rounded-xl p-4 flex items-center justify-between hover:bg-gray-50 transition">
                                    <div class="flex items-center gap-4">
                                        <div class="w-10 h-10 rounded-full bg-white border border-gray-200 flex items-center justify-center">
                                            <i class="fa-brands fa-google text-xl"></i>
                                        </div>
                                        <div>
                                            <div class="font-medium text-gray-900">Google Account</div>
                                            <div class="text-xs text-gray-500">Used for login and YouTube access</div>
                                        </div>
                                    </div>
                                    <a href="/oauth2/authorization/google" class="text-sm font-medium text-gray-600 hover:text-gray-900 border border-gray-300 px-3 py-1.5 rounded-lg hover:bg-gray-100 transition">
                                        Reconnect
                                    </a>
                                </div>
                            </section>
                        </div>

                        <!-- TAB: CHANNELS -->
                        <div x-show="activeTab === 'channels'" class="p-8 flex flex-col h-full animate-fade-in">
                            <div class="flex justify-between items-center mb-6">
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900">Social Channels</h3>
                                    <p class="text-sm text-gray-500">Manage your connected streaming destinations.</p>
                                </div>
                                <button @click="openConnectModal()" class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium px-4 py-2 rounded-lg transition shadow-sm shadow-blue-500/30 flex items-center gap-2">
                                    <i class="fa-solid fa-plus"></i> Connect Channel
                                </button>
                            </div>

                            <div class="space-y-3">
                                <template x-if="channels.length === 0">
                                    <div class="text-center py-12 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200">
                                        <i class="fa-solid fa-share-nodes text-4xl text-gray-300 mb-3"></i>
                                        <p class="text-gray-500 font-medium">No channels connected</p>
                                        <button @click="openConnectModal()" class="mt-2 text-blue-600 hover:text-blue-700 text-sm font-medium">Connect one now</button>
                                    </div>
                                </template>

                                <template x-for="channel in channels" :key="channel.id">
                                    <div class="group flex items-center gap-4 p-4 rounded-xl border border-gray-200 hover:border-blue-300 hover:bg-blue-50/50 transition bg-white">
                                        <div class="w-12 h-12 rounded-lg bg-gray-100 overflow-hidden border border-gray-200">
                                            <img :src="channel.profileUrl" class="w-full h-full object-cover">
                                        </div>
                                        <div class="flex-1">
                                            <h4 class="font-bold text-gray-900" x-text="channel.name"></h4>
                                            <div class="flex items-center gap-2 mt-0.5">
                                                <span class="text-xs font-medium px-2 py-0.5 rounded bg-gray-100 text-gray-600 uppercase" x-text="channel.platform"></span>
                                            </div>
                                        </div>
                                        <button @click="removeChannel(channel.id)" class="opacity-0 group-hover:opacity-100 transition p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg" title="Disconnect">
                                            <i class="fa-solid fa-trash-can"></i>
                                        </button>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- TAB: PLANS & BILLING -->
                        <div x-show="activeTab === 'plans'" class="p-8 animate-fade-in space-y-8 overflow-y-auto">

                            <!-- Current Usage -->
                            <section>
                                <h3 class="text-lg font-semibold text-gray-900 mb-4">Current Usage</h3>
                                <div class="bg-gray-900 text-white rounded-2xl p-6 shadow-lg shadow-gray-200 overflow-hidden relative">
                                    <div class="absolute top-0 right-0 p-32 bg-blue-500 rounded-full blur-3xl opacity-20 -mr-16 -mt-16"></div>

                                    <div class="relative z-10 flex flex-col md:flex-row justify-between md:items-end gap-6">
                                        <div>
                                            <div class="text-blue-200 font-medium text-sm uppercase tracking-wider mb-1">Current Plan</div>
                                            <div class="text-3xl font-bold" x-text="user?.plan?.name || 'Free'"></div>
                                            <div class="mt-4 flex items-center gap-2 text-sm text-gray-300">
                                                <i class="fa-solid fa-hard-drive"></i>
                                                <span>Storage Used: <span x-text="formattedStorage"></span></span>
                                            </div>
                                        </div>
                                        <div class="w-full md:w-64">
                                            <div class="flex justify-between text-xs mb-2 text-gray-400">
                                                <span>Capacity</span>
                                                <span x-text="storagePercentage.toFixed(0) + '%'"></span>
                                            </div>
                                            <div class="w-full h-2 bg-gray-700 rounded-full overflow-hidden">
                                                <div class="h-full bg-blue-500 rounded-full transition-all duration-500" :style="`width: ${storagePercentage}%`"></div>
                                            </div>
                                            <button @click="cancelSubscription()" class="mt-4 text-xs text-red-400 hover:text-red-300 font-medium transition">
                                                Cancel Subscription
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </section>

                            <!-- Upgrade Options -->
                            <section>
                                <h3 class="text-lg font-semibold text-gray-900 mb-4">Available Plans</h3>
                                <div x-show="isLoading" class="text-center py-8 text-gray-500">
                                    <i class="fa-solid fa-spinner fa-spin"></i> Loading plans...
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <template x-for="plan in plans" :key="plan.id">
                                        <div class="border rounded-2xl p-6 flex flex-col hover:shadow-lg transition duration-200 hover:-translate-y-1 bg-white relative overflow-hidden"
                                            :class="user?.plan?.name === plan.title ? 'border-blue-500 ring-1 ring-blue-500' : 'border-gray-200'">

                                            <div x-show="user?.plan?.name === plan.title" class="absolute top-0 right-0 bg-blue-500 text-white text-[10px] font-bold px-2 py-1 rounded-bl-lg">
                                                CURRENT
                                            </div>

                                            <h4 class="text-lg font-bold text-gray-900" x-text="plan.title"></h4>
                                            <div class="mt-2 mb-4">
                                                <span class="text-3xl font-bold text-gray-900" x-text="plan.price"></span>
                                                <span class="text-sm text-gray-500">/month</span>
                                            </div>

                                            <ul class="space-y-3 mb-8 flex-1">
                                                <!-- Mock features based on plan title -->
                                                <li class="flex items-start gap-2 text-sm text-gray-600">
                                                    <i class="fa-solid fa-check text-blue-500 mt-0.5"></i>
                                                    <span x-text="(plan.title === 'Free' ? '500MB' : (plan.title === 'Pro' ? '10GB' : '50GB')) + ' Storage'"></span>
                                                </li>
                                                <li class="flex items-start gap-2 text-sm text-gray-600">
                                                    <i class="fa-solid fa-check text-blue-500 mt-0.5"></i>
                                                    <span>Unlimited Streaming</span>
                                                </li>
                                            </ul>

                                            <button @click="openPayment(plan)"
                                                class="w-full py-2 rounded-lg font-semibold transition"
                                                :class="user?.plan?.name === plan.title ? 'bg-gray-100 text-gray-500 cursor-default' : 'bg-blue-600 hover:bg-blue-700 text-white shadow-sm shadow-blue-500/30'"
                                                :disabled="user?.plan?.name === plan.title"
                                                x-text="user?.plan?.name === plan.title ? 'Active' : 'Upgrade'">
                                            </button>
                                        </div>
                                    </template>
                                </div>
                            </section>
                        </div>

                    </div>
                </div>
            </div>

            <!-- PAYMENT CONFIRMATION MODAL (Alpine) -->
            <div x-show="paymentModalOpen" class="fixed inset-0 z-[100] bg-gray-900/50 backdrop-blur-sm flex items-center justify-center p-4" x-transition.opacity style="display:none;">
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 relative">
                    <button @click="paymentModalOpen = false" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>

                    <div class="text-center mb-6">
                        <div class="w-16 h-16 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fa-solid fa-rocket text-2xl"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900">Upgrade to <span x-text="selectedPlan?.title"></span></h3>
                        <p class="text-gray-500 text-sm mt-1">Unlock more storage and premium features.</p>
                    </div>

                    <div class="bg-gray-50 rounded-xl p-4 mb-6 border border-gray-100">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-medium text-gray-600">Total due today</span>
                            <span class="text-lg font-bold text-gray-900" x-text="selectedPlan?.price"></span>
                        </div>
                        <div class="flex items-center gap-2 text-xs text-gray-500">
                            <i class="fa-solid fa-lock"></i> Secure payment with Stripe
                        </div>
                    </div>

                    <button @click="processUpgrade()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg shadow-blue-500/30 transition transform active:scale-95">
                        Confirm & Pay
                    </button>
                </div>
            </div>

        </div>

    </main>
</div>

<!-- MODALS -->

<!-- Optimize Video Modal -->
<div id="optimizeModal" class="modal-overlay hidden">
    <div class="modal-box" style="width: 450px;">
        <div class="modal-header" style="border:none;">
            <h2>Optimize Video</h2>
            <button onclick="document.getElementById('optimizeModal').classList.add('hidden')" class="btn-close"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <p style="color:#666; margin-bottom:20px;">Create an optimized version for streaming.</p>

        <div class="form-group">
            <label>Format</label>
            <div class="platform-select">
                <div class="platform-option selected" onclick="selectOptimizeMode('landscape', this)">
                    <i class="fa-solid fa-desktop"></i> Landscape (16:9)
                </div>
                <div class="platform-option" onclick="selectOptimizeMode('portrait', this)">
                    <i class="fa-solid fa-mobile-screen"></i> Portrait (9:16)
                </div>
            </div>
        </div>

        <div class="form-group">
            <label>Quality / Resolution</label>
            <select id="optimizeQuality" class="form-input">
                <option value="1080">1080p (Full HD)</option>
                <option value="720">720p (HD)</option>
                <option value="2160">4K (Ultra HD)</option>
            </select>
        </div>

        <input type="hidden" id="optimizeFileName">
        <input type="hidden" id="optimizeMode" value="landscape">

        <div class="modal-actions" style="margin-top: 20px; text-align: right;">
            <button class="btn btn-text" onclick="document.getElementById('optimizeModal').classList.add('hidden')">Cancel</button>
            <button class="btn btn-primary" onclick="submitOptimization()">Start Optimization</button>
        </div>
    </div>
</div>

<!-- Connect Channel Modal -->
<div id="connectChannelModal" class="modal-overlay hidden">
    <div class="modal-box" style="width: 450px;">
        <div class="modal-header" style="padding: 0 0 20px 0; border: none;">
            <h2>Connect Channel</h2>
            <button onclick="document.getElementById('connectChannelModal').classList.add('hidden')" class="btn-close"><i class="fa-solid fa-xmark"></i></button>
        </div>

        <div class="form-group">
            <label>Select Platform</label>
            <div class="platform-select">
                <div class="platform-option selected" onclick="selectPlatform('YOUTUBE', this)">
                    <i class="fa-brands fa-youtube" style="color: red;"></i> YouTube
                </div>
                <div class="platform-option" onclick="selectPlatform('INSTAGRAM', this)">
                    <i class="fa-brands fa-instagram" style="color: #E1306C;"></i> Instagram
                </div>
                <div class="platform-option" onclick="selectPlatform('SNAPCHAT', this)">
                    <i class="fa-brands fa-snapchat" style="color: #FFFC00; -webkit-text-stroke: 1px black;"></i> Snapchat
                </div>
            </div>
        </div>

        <div id="manualChannelInput" class="hidden">
            <div class="form-group">
                <label>Channel Name / Handle</label>
                <input type="text" id="connectChannelName" class="form-input" placeholder="@handle">
                <small style="color:#666">Enter your handle to link this account.</small>
            </div>
        </div>

        <div class="modal-actions" style="margin-top: 20px; text-align: right;">
            <button class="btn btn-text" onclick="document.getElementById('connectChannelModal').classList.add('hidden')">Cancel</button>
            <button id="btnConnect" class="btn btn-primary" onclick="submitConnectChannel()">Connect</button>
        </div>
    </div>
</div>

<!-- Preview Modal (Library) -->
<div id="previewModal" class="modal-overlay hidden">
    <div class="modal-box" style="width: 800px; max-width: 95vw; background: black; padding: 0;">
        <div style="position:relative; width:100%; aspect-ratio:16/9;">
            <video id="mainPreviewVideo" controls autoplay style="width:100%; height:100%; display:block;"></video>
            <button onclick="document.getElementById('previewModal').classList.add('hidden'); document.getElementById('mainPreviewVideo').pause();" style="position:absolute; top:10px; right:10px; background:rgba(0,0,0,0.5); border:none; color:white; border-radius:50%; width:32px; height:32px; cursor:pointer;">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
    </div>
</div>

<!-- Destination Choice Modal -->
<div id="destChoiceModal" class="modal-overlay hidden">
    <div class="modal-box" style="width: 550px;">
        <div class="modal-header" style="border:none; padding-bottom: 5px;">
            <h2 style="font-size: 1.2rem;">Login to YouTube or setup stream manually</h2>
            <button onclick="document.getElementById('destChoiceModal').classList.add('hidden')" class="btn-close"><i class="fa-solid fa-xmark"></i></button>
        </div>

        <div style="padding: 10px 0;">
            <!-- Dynamic Channel List Container -->
            <div id="ytChannelList">
                <!-- Populated via JS -->
            </div>

            <div id="defaultYtFetchOption" onclick="connectYouTubeDestination()" class="queue-item hidden" style="cursor: pointer; border: 2px solid var(--primary); background: #f0f7ff; margin-bottom: 15px;">
                <div style="background: white; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                    <i class="fa-brands fa-youtube" style="color: red; font-size: 1.5rem;"></i>
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: 700; font-size: 1.05rem; display: flex; align-items: center; gap: 10px; color: var(--primary-dark);">
                        Fetch from YouTube
                        <span style="background: var(--success); color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; font-weight: 600;">RECOMMENDED</span>
                    </div>
                    <div style="font-size: 0.9rem; color: var(--text-muted); margin-top: 4px;">Get Stream Key from connected account</div>
                </div>
                <i class="fa-solid fa-chevron-right" style="color: var(--primary);"></i>
            </div>

            <!-- Manual Option -->
            <div onclick="openManualDestinationModal()" class="queue-item" style="cursor: pointer;">
                 <div style="background: #f4f5f7; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;">
                    <i class="fa-solid fa-sliders" style="color: var(--text-muted); font-size: 1.2rem;"></i>
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: 700; font-size: 1.05rem; display: flex; align-items: center; gap: 10px;">
                        Manual setup
                        <span style="background: #eee; color: #666; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; font-weight: 600;">CLASSIC</span>
                    </div>
                    <div style="font-size: 0.9rem; color: var(--text-muted); margin-top: 4px;">Create and enter stream and key manually</div>
                </div>
                 <i class="fa-solid fa-chevron-right" style="color: var(--text-muted);"></i>
            </div>
        </div>
    </div>
</div>

<!-- Add Destination Modal (Manual) -->
<div id="addDestinationModal" class="modal-overlay hidden">
    <div class="modal-box" style="width: 400px;">
        <div class="modal-header" style="padding: 0 0 20px 0; border: none;">
            <h2>Add Destination</h2>
            <button onclick="document.getElementById('addDestinationModal').classList.add('hidden')" class="btn-close"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="form-group">
            <label>Name</label>
            <input type="text" id="newDestName" class="form-input" placeholder="e.g. YouTube Gaming">
        </div>
        <div class="form-group">
            <label>Stream Key</label>
            <div style="position: relative;">
                <input type="password" id="newDestKey" class="form-input" placeholder="rtmp://..." style="padding-right: 40px;">
                <button type="button" onclick="toggleStreamKeyVisibility('newDestKey', this)" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #666; cursor: pointer;">
                    <i class="fa-solid fa-eye"></i>
                </button>
            </div>
        </div>
        <div class="modal-actions" style="margin-top: 20px; text-align: right;">
            <button class="btn btn-text" onclick="document.getElementById('addDestinationModal').classList.add('hidden')">Cancel</button>
            <button class="btn btn-primary" onclick="submitDestination()">Save Destination</button>
        </div>
    </div>
</div>

<!-- Engagement Settings Modal -->
<div id="engagementSettingsModal" class="modal-overlay hidden">
    <div class="modal-box" style="width: 500px;">
        <div class="modal-header" style="border:none;">
            <h2>Engagement Automation</h2>
            <button onclick="document.getElementById('engagementSettingsModal').classList.add('hidden')" class="btn-close"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <p style="color:#666; margin-bottom:20px;">Automatically manage comments using AI (Gemini).</p>

        <div class="form-group" style="display:flex; align-items:center; justify-content:space-between; margin-bottom: 20px;">
            <div>
                <label style="margin:0; font-weight:600;">Auto-Like & Reply Positive</label>
                <div style="font-size:0.85rem; color:#888;">Like positive comments and reply with a smiley.</div>
            </div>
            <label class="switch">
                <input type="checkbox" id="engAutoReply">
                <span class="slider round"></span>
            </label>
        </div>

        <div class="form-group" style="display:flex; align-items:center; justify-content:space-between;">
            <div>
                <label style="margin:0; font-weight:600;">Delete Negative Comments</label>
                <div style="font-size:0.85rem; color:#888;">Automatically remove hate speech or negative sentiment.</div>
            </div>
            <label class="switch">
                <input type="checkbox" id="engDeleteNegative">
                <span class="slider round"></span>
            </label>
        </div>

        <div class="modal-actions" style="text-align:right; margin-top:30px;">
            <button class="btn btn-primary" onclick="saveEngagementSettings()">Save Changes</button>
        </div>
    </div>
</div>

<!-- Internal Payment Modal -->
<div id="paymentModal" class="modal-overlay hidden">
    <div class="modal-box" style="width: 400px; text-align: center;">
        <h2>Confirm Subscription</h2>
        <p id="paymentPlanName" style="margin: 10px 0; font-size: 1.1rem; color: var(--primary);">Upgrade Plan</p>
        <div style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 8px; text-align: left;">
            <div style="display:flex; justify-content:space-between; margin-bottom: 10px;">
                <span>Total due today:</span>
                <strong id="paymentAmount">$0.00</strong>
            </div>
            <div style="font-size: 0.9rem; color: #666;">
                <i class="fa-solid fa-credit-card"></i> **** **** **** 4242
            </div>
        </div>
        <button id="btnConfirmPayment" class="btn btn-primary btn-block btn-lg" onclick="processPayment()">Pay & Upgrade</button>
        <button class="btn btn-text" onclick="document.getElementById('paymentModal').classList.add('hidden')" style="margin-top: 10px;">Cancel</button>
    </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmationModal" class="modal-overlay hidden">
    <div class="modal-box" style="width: 350px; text-align: center;">
        <i class="fa-solid fa-circle-exclamation" style="font-size: 3rem; color: #ffab00; margin-bottom: 15px;"></i>
        <h3 id="confirmTitle" style="margin: 0 0 10px 0;">Are you sure?</h3>
        <p id="confirmMessage" style="color: #666; font-size: 0.95rem; margin-bottom: 25px;">This action cannot be undone.</p>
        <div style="display: flex; gap: 10px; justify-content: center;">
            <button class="btn btn-outline" onclick="closeConfirmModal()">Cancel</button>
            <button id="btnConfirmAction" class="btn btn-danger">Confirm</button>
        </div>
    </div>
</div>

<!-- Support Modal -->
<div id="supportModal" class="modal-overlay hidden">
    <div class="modal-box" style="width: 400px;">
        <div class="modal-header" style="border:none;">
            <h2>Contact Support</h2>
            <button onclick="document.getElementById('supportModal').classList.add('hidden')" class="btn-close"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <p>Need help? Our team is available 24/7.</p>
        <div style="background: #f4f6f8; padding: 15px; border-radius: 6px; margin: 20px 0;">
            <div style="margin-bottom: 10px;"><i class="fa-solid fa-envelope"></i> <b>Email:</b> support@afklive.com</div>
            <div><i class="fa-solid fa-book"></i> <b>Docs:</b> docs.afklive.com</div>
        </div>
        <button class="btn btn-primary btn-block" onclick="document.getElementById('supportModal').classList.add('hidden')">Close</button>
    </div>
</div>

<!-- Schedule Modal -->
<div id="scheduleModal" class="modal-overlay hidden">
    <div class="modal-composer">
        <div class="modal-header">
            <h2>Create Post</h2>
            <button onclick="closeScheduleModal()" class="btn-close"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="modal-body">
            <div class="composer-grid">
                <div class="composer-main">
                    <!-- Step 1: Channel -->
                    <div class="form-group">
                        <label>Post to</label>
                        <div id="modalChannelSelector" class="channel-selector-row"></div>
                    </div>

                    <!-- Step 2: Content -->
                    <div class="form-group">
                        <textarea id="scheduleDescription" class="composer-textarea" placeholder="What would you like to share?"></textarea>
                        <div class="composer-tools">
                             <button class="tool-btn" onclick="aiGenerate('description')" title="AI Assist"><i class="fa-solid fa-wand-magic-sparkles"></i> AI Write</button>
                             <button class="tool-btn" onclick="document.getElementById('scheduleTags').focus()"><i class="fa-solid fa-hashtag"></i> Tags</button>
                        </div>
                    </div>

                    <div class="media-upload-area" id="dropZone">
                        <div id="mediaPlaceholder">
                            <i class="fa-regular fa-image"></i>
                            <span>Add Video</span>
                        </div>
                        <div id="selectedFileDisplay" class="hidden">
                            <i class="fa-solid fa-file-video"></i> <span id="fileName">video.mp4</span>
                        </div>
                        <input type="file" id="scheduleFile" accept="video/*" hidden>
                    </div>

                    <!-- Thumbnail Tools -->
                    <div id="thumbnailTools" class="hidden" style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px; display: flex; align-items: center; justify-content: space-between;">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <div id="thumbPreview" style="width: 60px; height: 34px; background: #ddd; border-radius: 4px; overflow: hidden; display: flex; align-items: center; justify-content: center;">
                                <i class="fa-regular fa-image"></i>
                            </div>
                            <span style="font-size: 0.9rem; font-weight: 500;">Thumbnail</span>
                        </div>
                        <div style="display:flex; gap:10px;">
                            <button class="btn btn-sm btn-outline" onclick="extractFrame()" title="Extract from Video"><i class="fa-solid fa-camera"></i> Auto</button>
                            <a href="https://www.canva.com/create/youtube-thumbnails/" target="_blank" class="btn btn-sm btn-outline" style="color: #5d26c9; border-color: #5d26c9;"><i class="fa-solid fa-wand-magic-sparkles"></i> Canva</a>
                            <button class="btn btn-sm btn-outline" onclick="document.getElementById('scheduleThumbnail').click()"><i class="fa-solid fa-upload"></i> Upload</button>
                        </div>
                        <input type="file" id="scheduleThumbnail" accept="image/*" hidden>
                    </div>

                    <!-- Hidden Video for Extraction -->
                    <video id="frameExtractorVideo" style="display: none;" crossorigin="anonymous"></video>

                    <!-- Progress -->
                    <div id="uploadProgressContainer" class="hidden">
                        <div class="progress-track"><div id="uploadProgressBar" class="progress-fill"></div></div>
                        <small id="uploadPercent">0%</small>
                    </div>

                    <!-- Details -->
                     <div class="form-row">
                        <div class="form-group">
                            <label>Title</label>
                            <input type="text" id="scheduleTitle" class="form-input">
                        </div>
                         <div class="form-group">
                            <label>Time</label>
                            <input type="datetime-local" id="scheduleTime" class="form-input">
                        </div>
                    </div>

                    <div class="collapsible-details">
                         <div class="form-row">
                             <div class="form-group">
                                <label>Category</label>
                                <select id="scheduleCategory" class="form-input"></select>
                             </div>
                             <div class="form-group">
                                <label>Privacy</label>
                                <select id="schedulePrivacy" class="form-input">
                                    <option value="private">Private</option>
                                    <option value="public">Public</option>
                                </select>
                             </div>
                         </div>
                         <div class="form-group">
                             <input type="text" id="scheduleTags" placeholder="Tags (comma separated)" class="form-input">
                         </div>

                         <div class="form-group">
                            <label>First Comment (Pinned)</label>
                            <textarea id="scheduleFirstComment" class="form-input" rows="2" placeholder="Post a comment immediately after upload..."></textarea>
                         </div>

                         <div style="margin-top:15px; padding-top:15px; border-top:1px solid #eee;">
                            <h4 style="margin:0 0 10px 0; font-size:0.95rem;">Audio & Music</h4>

                            <div style="display:flex; gap:10px; margin-bottom:10px;">
                                <button class="btn btn-sm btn-primary" id="tabAudioUpload" onclick="switchAudioTab('upload')">Upload</button>
                                <button class="btn btn-sm btn-outline" id="tabAudioLib" onclick="switchAudioTab('lib')">Stock Library</button>
                            </div>

                            <!-- Upload Tab -->
                            <div id="audioUploadSection">
                                <div class="form-group">
                                    <label>Backing Track (Optional)</label>
                                    <input type="file" id="scheduleAudio" accept=".mp3,.wav" class="form-control" style="font-size:0.9rem;">
                                </div>
                            </div>

                            <!-- Library Tab -->
                            <div id="audioLibSection" class="hidden">
                                <div id="audioTrackList" class="scroll-list" style="height:150px; border:1px solid #eee; border-radius:4px; margin-bottom:10px;">
                                    Loading...
                                </div>
                                <input type="hidden" id="selectedAudioTrackId">
                                <div id="selectedTrackName" style="font-size:0.85rem; font-weight:600; color:var(--primary);"></div>
                            </div>

                            <div class="form-group">
                                <label>Music Volume (<span id="volVal">50%</span>)</label>
                                <input type="range" id="scheduleAudioVol" min="0" max="200" value="50" style="width:100%" oninput="document.getElementById('volVal').innerText = this.value + '%'">
                                <div style="font-size:0.8rem; color:#888;">100% = Original volume. 200% = Boost.</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="composer-preview">
                    <div class="preview-card">
                        <div class="preview-card-header">
                            <i class="fa-brands fa-youtube" style="color:red"></i>
                            <span style="font-weight:600; font-size:0.9rem;">YouTube Preview</span>
                        </div>
                        <div style="display:flex; justify-content:space-between; align-items:center; padding: 0 10px 5px;">
                            <span style="font-size:0.8rem; color:#666;">Preview Mode:</span>
                            <div class="toggle-group">
                                <button class="btn btn-xs btn-primary" onclick="setPreviewMode('standard')">16:9</button>
                                <button class="btn btn-xs btn-outline" onclick="setPreviewMode('shorts')">9:16</button>
                            </div>
                        </div>

                        <div class="preview-card-image" id="previewImageMock">
                            <i class="fa-solid fa-play"></i>
                            <!-- Safe Zone Overlay for Shorts -->
                            <div id="shortsSafeZone" class="hidden" style="position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none;">
                                <div style="position:absolute; bottom:120px; right:10px; display:flex; flex-direction:column; gap:15px; color:rgba(255,255,255,0.7); align-items:center;">
                                    <i class="fa-solid fa-thumbs-up fa-lg"></i>
                                    <i class="fa-solid fa-comment-dots fa-lg"></i>
                                    <i class="fa-solid fa-share fa-lg"></i>
                                </div>
                                <div style="position:absolute; bottom:20px; left:10px; color:white; font-size:0.8rem;">
                                    <div style="width:30px; height:30px; background:#ccc; border-radius:50%; margin-bottom:5px;"></div>
                                    Channel Name
                                </div>
                            </div>
                        </div>
                        <div class="preview-card-body">
                            <h4 id="previewTitleMock" style="margin:0 0 5px 0; font-size:0.95rem;">Video Title</h4>
                            <div id="previewDescMock" style="font-size:0.85rem; color:#666; line-height:1.4;">
                                Description will appear here...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" id="btnSchedule" onclick="submitSchedule()">Schedule Post</button>
        </div>
    </div>
</div>

<!-- Auto Schedule Modal -->
<div id="autoScheduleModal" class="modal-overlay hidden">
    <div class="modal-box">
        <h3>Auto Schedule</h3>
        <p>Automatically distribute your library content.</p>
        <div class="form-group">
            <label>Start Date</label>
            <input type="date" id="autoStartDate" class="form-input">
        </div>
        <div class="form-group">
            <label>Times (HH:mm)</label>
            <input type="text" id="autoTimeSlots" placeholder="10:00, 15:00" class="form-input">
        </div>

        <div style="border-top:1px solid #eee; margin: 15px 0; padding-top:15px;">
            <h4 style="margin: 0 0 10px 0;">AI Enhancement</h4>
            <div class="form-group">
                <label>Base Topic (Optional)</label>
                <input type="text" id="autoTopic" placeholder="e.g. Minecraft Gameplay" class="form-input">
            </div>
            <div class="form-group" style="display:flex; align-items:center; gap:10px;">
                <input type="checkbox" id="autoUseAi">
                <label for="autoUseAi" style="margin:0; font-weight:400;">Generate Titles, Descriptions & Tags with AI</label>
            </div>
        </div>

        <div class="modal-actions">
            <button class="btn btn-primary" onclick="submitAutoSchedule()">Apply</button>
            <button class="btn btn-text" onclick="document.getElementById('autoScheduleModal').classList.add('hidden')">Cancel</button>
        </div>
    </div>
</div>

<!-- Stream Library Modal -->
<div id="streamLibraryModal" class="modal-overlay hidden">
    <div class="modal-box" style="width: 500px;">
        <div class="modal-header" style="border:none; padding-bottom: 10px;">
            <h2>Select Video</h2>
            <button onclick="document.getElementById('streamLibraryModal').classList.add('hidden')" class="btn-close"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div id="streamLibraryList" class="scroll-list" style="height: 300px; padding: 0;"></div>
    </div>
</div>

<!-- YouTube Import Modal -->
<div id="youtubeImportModal" class="modal-overlay hidden">
    <div class="modal-box" style="width: 450px;">
        <div class="modal-header" style="border:none; padding-bottom: 10px;">
            <h2>Import from YouTube</h2>
            <button onclick="document.getElementById('youtubeImportModal').classList.add('hidden')" class="btn-close"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="form-group">
            <label>Video URL</label>
            <input type="text" id="ytImportUrl" class="form-input" placeholder="https://youtube.com/watch?v=...">
            <small style="color:#666;">Video will be downloaded to your library.</small>
        </div>
        <div class="modal-actions" style="margin-top: 20px; text-align: right;">
            <button class="btn btn-text" onclick="document.getElementById('youtubeImportModal').classList.add('hidden')">Cancel</button>
            <button class="btn btn-primary" onclick="submitYouTubeImport()">Import</button>
        </div>
    </div>
</div>

<!-- Scheduled Streams List Modal -->
<div id="scheduledStreamsModal" class="modal-overlay hidden">
    <div class="modal-box" style="width: 600px;">
        <div class="modal-header" style="border:none; padding-bottom: 10px;">
            <h2>Scheduled Streams</h2>
            <button onclick="document.getElementById('scheduledStreamsModal').classList.add('hidden')" class="btn-close"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div id="scheduledStreamsList" class="scroll-list" style="max-height: 400px; overflow-y:auto; padding: 0;">
            Loading...
        </div>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="js/toast.js"></script>
<script src="js/stream-studio.js"></script>
<script src="js/settings.js"></script>
<script src="js/app.js"></script>
</body>
</html>
