<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AFK Live</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- FullCalendar CSS Fix for Tailwind Conflict -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="css/theme.css">
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48'%3E%3Cpath d='M24 2 A22 22 0 0 1 46 24' fill='none' stroke='%23667eea' stroke-width='4' /%3E%3Cpath d='M46 24 A22 22 0 0 1 24 46' fill='none' stroke='%23764ba2' stroke-width='4' /%3E%3Cpolygon points='20,14 20,34 36,24' fill='%23764ba2' /%3E%3C/svg%3E">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2c68f6',
                        'primary-dark': '#1b53d6',
                        danger: '#e02424',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
</head>
<body>

<!-- Mobile Sidebar Overlay -->
<div id="sidebarOverlay" class="sidebar-overlay" onclick="toggleMobileMenu()"></div>

<div class="app-layout">


    <!-- LEVEL 2: NAV SIDEBAR (Contextual) -->
    <nav class="sub-sidebar" id="subSidebar">
        <div class="sidebar-header">
            <h2 id="sidebarTitle">Publishing</h2>
            <div class="dropdown-trigger" onclick="toggleChannelDropdown()">
                 <span id="currentChannelName">All Channels</span> <i class="fa-solid fa-chevron-down"></i>
            </div>
            <!-- Dropdown Menu -->
            <div id="channelDropdownMenu" class="dropdown-menu">
                <!-- Populated via JS -->
            </div>
        </div>

        <div class="menu">
            <a href="#" class="menu-item" data-target="view-publish" onclick="switchView('publish')">
                <i class="fa-regular fa-paper-plane"></i>
                <span>Queue</span>
                <span class="ml-auto text-[9px] bg-purple-50 text-purple-600 border border-purple-100 px-1.5 py-0.5 rounded font-bold uppercase tracking-wider">Beta</span>
            </a>
            <a href="#" class="menu-item" data-target="view-calendar" onclick="switchView('calendar')">
                <i class="fa-regular fa-calendar"></i>
                <span>Calendar</span>
                <span class="ml-auto text-[9px] bg-purple-50 text-purple-600 border border-purple-100 px-1.5 py-0.5 rounded font-bold uppercase tracking-wider">Beta</span>
            </a>
            <div class="menu-divider"></div>
            <a href="#" class="menu-item active" data-target="view-stream" onclick="switchView('stream')">
                <i class="fa-solid fa-satellite-dish"></i>
                <span>Live Studio</span>
            </a>
             <a href="#" class="menu-item" data-target="view-community" onclick="switchView('community')">
                <i class="fa-regular fa-comments"></i>
                <span>Engagement</span>
                <span class="ml-auto text-[9px] bg-purple-50 text-purple-600 border border-purple-100 px-1.5 py-0.5 rounded font-bold uppercase tracking-wider">Beta</span>
            </a>
            <a href="#" class="menu-item" data-target="view-analytics" onclick="switchView('analytics')">
                <i class="fa-solid fa-chart-line"></i>
                <span>Analytics</span>
                <span class="ml-auto text-[9px] bg-purple-50 text-purple-600 border border-purple-100 px-1.5 py-0.5 rounded font-bold uppercase tracking-wider">Beta</span>
            </a>
            <a href="#" class="menu-item" data-target="view-library" onclick="switchView('library')">
                <i class="fa-regular fa-folder"></i>
                <span>Media Library</span>
            </a>
            <div class="menu-divider"></div>
             <a href="#" class="menu-item" data-target="view-settings" onclick="switchView('settings')">
                <i class="fa-solid fa-gear"></i>
                <span>Settings</span>
            </a>
        </div>

        <div class="sidebar-footer">
             <a href="#" class="menu-item" onclick="openSupportModal()">
                <i class="fa-regular fa-life-ring"></i>
                <span>Support</span>
            </a>
             <a href="/logout" class="menu-item logout">
                <i class="fa-solid fa-right-from-bracket"></i>
                <span>Logout</span>
            </a>
        </div>
    </nav>

    <!-- LEVEL 3: CONTENT -->
    <main class="content-area">

        <!-- Mobile Header -->
        <header class="mobile-header">
            <button class="hamburger" onclick="toggleMobileMenu()"><i class="fa-solid fa-bars"></i></button>
            <div class="afk-logo" style="transform: scale(0.6); transform-origin: left center;">
                <div class="afk-icon"><div class="afk-play"></div></div>
                <div class="afk-text">AFK<span class="afk-live">Live</span></div>
            </div>
        </header>

        <div id="verificationBanner" class="hidden warning-banner">
            ⚠️ Please verify your email address to access all features.
        </div>

        <!-- VIEW: PUBLISH (Alpine + Tailwind) -->
        <div id="view-publish" class="view-section hidden bg-gray-50 font-sans" x-data="contentStudio">
            <div class="max-w-6xl mx-auto h-full flex flex-col">
                <header class="mb-8 flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900 tracking-tight">Content Queue</h1>
                        <p class="text-gray-500 mt-1">Scheduled uploads and recent activity.</p>
                    </div>
                    <button onclick="showScheduleModal()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2.5 px-5 rounded-xl shadow-lg shadow-blue-500/30 transition flex items-center gap-2 transform active:scale-95">
                        <i class="fa-solid fa-pen-to-square"></i>
                        <span>Create Post</span>
                    </button>
                </header>

                <!-- Queue List -->
                <div class="flex-1 overflow-y-auto">
                    <div x-show="isLoadingQueue" class="text-center py-12 text-gray-500">
                        <div class="afk-loader mb-2"></div>
                        <p>Loading queue...</p>
                    </div>

                    <div x-show="!isLoadingQueue && queue.length === 0" class="text-center py-20 bg-white rounded-2xl border border-dashed border-gray-300">
                        <div class="w-16 h-16 bg-gray-50 text-gray-400 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fa-regular fa-paper-plane text-2xl"></i>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900">Your queue is empty</h3>
                        <p class="text-gray-500 text-sm mt-1">Schedule your first video to get started.</p>
                    </div>

                    <div class="space-y-3" x-show="!isLoadingQueue && queue.length > 0">
                        <template x-for="item in queue" :key="item.id">
                            <div class="group bg-white rounded-xl p-4 border border-gray-200 hover:border-blue-300 hover:shadow-md transition flex flex-col md:flex-row md:items-center gap-4">
                                <!-- Thumb -->
                                <div class="w-full md:w-32 aspect-video bg-gray-100 rounded-lg overflow-hidden relative flex-shrink-0">
                                    <template x-if="item.thumbnailS3Key">
                                        <img :src="`/api/videos/${item.id}/thumbnail`" class="w-full h-full object-cover">
                                    </template>
                                    <template x-if="!item.thumbnailS3Key">
                                        <div class="w-full h-full flex items-center justify-center text-gray-300">
                                            <i class="fa-solid fa-film text-2xl"></i>
                                        </div>
                                    </template>
                                </div>

                                <!-- Info -->
                                <div class="flex-1 min-w-0">
                                    <h3 class="text-base font-bold text-gray-900 truncate" x-text="item.title"></h3>
                                    <div class="flex items-center gap-3 mt-1 text-xs text-gray-500">
                                        <span class="flex items-center gap-1"><i class="fa-regular fa-clock"></i> <span x-text="formatDate(item.scheduledTime)"></span></span>
                                        <span class="w-1 h-1 rounded-full bg-gray-300"></span>
                                        <span class="flex items-center gap-1"><i class="fa-solid fa-layer-group"></i> <span>YouTube</span></span>
                                    </div>
                                </div>

                                <!-- Status -->
                                <div class="flex items-center justify-between md:justify-end gap-4 mt-2 md:mt-0 w-full md:w-auto">
                                    <span class="px-2.5 py-1 rounded-full text-xs font-bold uppercase tracking-wide"
                                          :class="getStatusColor(item.status)"
                                          x-text="item.status"></span>

                                    <div class="flex gap-2 opacity-100 md:opacity-0 group-hover:opacity-100 transition">
                                        <button class="p-2 text-gray-400 hover:text-blue-600 rounded-lg hover:bg-blue-50 transition" title="Edit">
                                            <i class="fa-solid fa-pencil"></i>
                                        </button>
                                        <button class="p-2 text-gray-400 hover:text-red-600 rounded-lg hover:bg-red-50 transition" title="Delete">
                                            <i class="fa-solid fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- Pagination -->
                    <div class="flex justify-between items-center py-4 border-t border-gray-200 mb-10" x-show="!isLoadingLibrary && libTotal > libLimit">
                         <span class="text-sm text-gray-500">
                             Page <span x-text="libPage"></span> of <span x-text="libTotalPages"></span>
                         </span>
                         <div class="flex gap-2">
                             <button @click="libPage--; loadLibrary()" :disabled="libPage <= 1" class="px-3 py-1 bg-white border rounded hover:bg-gray-50 text-sm disabled:opacity-50 disabled:cursor-not-allowed">Prev</button>
                             <button @click="libPage++; loadLibrary()" :disabled="libPage >= libTotalPages" class="px-3 py-1 bg-white border rounded hover:bg-gray-50 text-sm disabled:opacity-50 disabled:cursor-not-allowed">Next</button>
                         </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: STREAM (Alpine & Tailwind - Apple Style) -->
        <div id="view-stream" class="view-section hidden h-full p-0 overflow-hidden bg-gray-50 font-sans" x-data="streamStudio">
            <div class="flex flex-col lg:flex-row h-full w-full">

                <!-- LEFT: STAGE -->
                <div class="flex-1 flex flex-col relative overflow-hidden bg-gray-100 lg:bg-transparent">
                    <!-- Header / Top Bar -->
                    <div class="h-16 flex items-center justify-between px-8 z-10">
                        <div class="flex items-center gap-3">
                            <span class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Studio</span>
                            <span x-show="isLive" class="bg-red-50 text-red-600 border border-red-100 px-2 py-0.5 rounded text-xs font-bold animate-pulse flex items-center gap-1">
                                <span class="w-1.5 h-1.5 rounded-full bg-red-600"></span> LIVE
                            </span>
                        </div>
                    </div>

                    <!-- Main Preview Area -->
                    <div class="flex-1 flex items-center justify-center p-4 lg:p-8 lg:pb-32 min-h-[300px]">
                        <div class="relative w-full max-w-4xl aspect-video bg-black rounded-2xl shadow-2xl overflow-hidden ring-1 ring-black/5 group">
                            <!-- Placeholder -->
                            <div x-show="!selectedVideo" class="absolute inset-0 flex flex-col items-center justify-center text-gray-500">
                                <i class="fa-solid fa-film text-4xl lg:text-6xl mb-4 opacity-20"></i>
                                <p class="font-medium text-sm lg:text-lg">No Source Selected</p>
                                <button @click="openSourceSelector()" class="mt-4 px-4 py-2 text-sm lg:px-5 lg:py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-full font-medium transition shadow-lg shadow-blue-600/20">
                                    Select Video
                                </button>
                            </div>

                            <!-- Video Player -->
                            <video id="previewPlayer" class="w-full h-full object-contain" x-show="selectedVideo" controls playsinline></video>

                            <!-- Title Overlay (On Hover) -->
                            <div x-show="selectedVideo" class="absolute top-0 left-0 w-full p-6 bg-gradient-to-b from-black/60 to-transparent opacity-0 group-hover:opacity-100 transition duration-300 pointer-events-none hidden lg:block">
                                <h3 class="text-white font-medium text-lg" x-text="selectedVideo?.title"></h3>
                            </div>
                        </div>
                    </div>

                    <!-- Floating Control Dock -->
                    <div class="absolute bottom-4 lg:bottom-8 left-1/2 -translate-x-1/2 z-20 w-full max-w-[90%] lg:w-auto">
                        <div class="bg-white/80 backdrop-blur-xl border border-white/40 shadow-xl shadow-gray-200/50 rounded-2xl p-2 flex items-center gap-2 ring-1 ring-gray-900/5">

                            <!-- Source Select -->
                            <button @click="openSourceSelector()" class="p-3 rounded-xl hover:bg-gray-100 text-gray-600 hover:text-gray-900 transition tooltip-trigger relative group">
                                <i class="fa-solid fa-folder-open text-xl"></i>
                                <span class="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 bg-gray-900 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition whitespace-nowrap pointer-events-none">Source</span>
                            </button>

                            <div class="w-px h-8 bg-gray-200 mx-1"></div>

                            <!-- Mute -->
                            <button @click="muteOriginal = !muteOriginal" :class="muteOriginal ? 'bg-blue-50 text-blue-600' : 'text-gray-500 hover:bg-gray-100'" class="p-3 rounded-xl transition relative group">
                                <i class="fa-solid" :class="muteOriginal ? 'fa-volume-xmark' : 'fa-volume-high'"></i>
                            </button>

                            <!-- Loop -->
                            <button @click="loopVideo = !loopVideo" :class="loopVideo ? 'bg-blue-50 text-blue-600' : 'text-gray-500 hover:bg-gray-100'" class="p-3 rounded-xl transition relative group">
                                <i class="fa-solid fa-repeat"></i>
                            </button>

                            <div class="w-px h-8 bg-gray-200 mx-1"></div>

                            <!-- Main Action -->
                            <button @click="startStream()" :disabled="isBusy"
                                class="px-6 py-3 rounded-xl font-bold text-white shadow-lg transition transform active:scale-95 flex items-center gap-2 min-w-[140px] justify-center bg-red-600 hover:bg-red-700 shadow-red-500/30">
                                <i x-show="isBusy" class="fa-solid fa-spinner fa-spin"></i>
                                <span x-show="!isBusy">Go Live</span>
                            </button>

                        </div>
                    </div>

                     <!-- Modal: Source Selector (Tailwind) -->
                    <div x-show="showLibraryModal" class="absolute inset-0 z-50 bg-gray-900/20 backdrop-blur-sm flex items-center justify-center p-8" x-transition.opacity style="display:none;">
                        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-full flex flex-col overflow-hidden ring-1 ring-gray-900/5">
                            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                                <h3 class="font-semibold text-gray-900">Select Source</h3>
                                <div class="flex items-center gap-3">
                                    <button class="text-sm text-blue-600 font-medium hover:bg-blue-50 px-3 py-1.5 rounded-lg transition" onclick="document.getElementById('studioVideoUpload').click()">
                                        <i class="fa-solid fa-cloud-arrow-up mr-1"></i> Upload
                                    </button>
                                    <input type="file" id="studioVideoUpload" hidden accept="video/*" @change="handleVideoUpload($event)">
                                    <button @click="showLibraryModal = false" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
                                </div>
                            </div>
                            <div class="flex-1 overflow-y-auto p-4 space-y-2">
                                <template x-if="isLoadingLibrary">
                                    <div class="text-center py-8 text-gray-500"><i class="fa-solid fa-spinner fa-spin"></i> Loading library...</div>
                                </template>
                                <template x-for="video in libraryVideos" :key="video.id">
                                    <div @click="selectVideo(video)" class="flex items-center gap-4 p-3 rounded-xl hover:bg-blue-50 cursor-pointer group transition border border-transparent hover:border-blue-100">
                                        <div class="w-16 h-10 bg-gray-200 rounded-lg overflow-hidden relative">
                                             <!-- If thumbnail exists -->
                                             <img x-show="video.thumbnailS3Key" :src="`/api/videos/${video.id}/thumbnail`" class="w-full h-full object-cover">
                                             <div x-show="!video.thumbnailS3Key" class="absolute inset-0 flex items-center justify-center text-gray-400"><i class="fa-solid fa-film"></i></div>
                                        </div>
                                        <div class="flex-1">
                                            <h4 class="font-medium text-gray-900 text-sm group-hover:text-blue-700" x-text="video.title"></h4>
                                            <div class="flex items-center gap-2 mt-1">
                                                 <span class="text-xs text-gray-500" x-text="(video.fileSize / 1024 / 1024).toFixed(1) + ' MB'"></span>
                                                 <span x-show="video.optimizationStatus === 'COMPLETED'" class="text-[10px] font-bold bg-green-100 text-green-700 px-1.5 py-0.5 rounded">OPTIMIZED</span>
                                            </div>
                                        </div>
                                        <i class="fa-solid fa-chevron-right text-gray-300 group-hover:text-blue-500"></i>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- RIGHT: SIDEBAR -->
                <div class="w-full lg:w-96 bg-white border-t lg:border-t-0 lg:border-l border-gray-200 flex flex-col shadow-xl shadow-gray-200/50 z-30 h-1/2 lg:h-full">

                    <!-- Tabs -->
                    <div class="p-4 pb-0">
                        <div class="flex p-1 bg-gray-100 rounded-lg overflow-x-auto">
                            <template x-for="tab in ['setup', 'audio', 'brand', 'streams']">
                                <button @click="switchTab(tab)"
                                    class="flex-1 py-1.5 text-xs font-semibold rounded-md transition capitalize whitespace-nowrap px-2"
                                    :class="activeTab === tab ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-500 hover:text-gray-700'"
                                    x-text="tab === 'setup' ? 'Setup' : tab">
                                </button>
                            </template>
                        </div>
                    </div>

                    <!-- Content -->
                    <div class="flex-1 overflow-y-auto p-5">

                        <!-- SETUP TAB -->
                        <div x-show="activeTab === 'setup'" class="space-y-6">
                            <!-- Destinations -->
                            <section>
                                <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Destinations</h4>
                                <div class="space-y-2">
                                     <template x-for="dest in destinations" :key="dest.id">
                                         <div class="flex items-center gap-3 p-3 rounded-xl border transition group"
                                             :class="dest.selected ? 'bg-blue-50 border-blue-200' : 'bg-white border-gray-200 hover:border-gray-300'"
                                             x-data="{ showKey: false }">

                                             <!-- Selection Toggle -->
                                             <div @click="toggleDest(dest.id)" class="cursor-pointer flex items-center gap-3 flex-1 min-w-0">
                                                 <div class="w-5 h-5 rounded-full border flex items-center justify-center shrink-0"
                                                     :class="dest.selected ? 'bg-blue-600 border-blue-600' : 'border-gray-300 bg-white'">
                                                     <i x-show="dest.selected" class="fa-solid fa-check text-white text-xs"></i>
                                                 </div>
                                                 <div class="flex-1 min-w-0">
                                                     <div class="text-sm font-medium text-gray-900 truncate" x-text="dest.name"></div>
                                                     <div class="text-[10px] text-gray-400 font-mono truncate"
                                                          x-text="showKey ? (dest.streamKey || dest.key || 'N/A') : 'Key: •••••' + ((dest.streamKey || dest.key) && (dest.streamKey || dest.key).length > 4 ? (dest.streamKey || dest.key).slice(-4) : '****')">
                                                     </div>
                                                 </div>
                                             </div>

                                             <!-- Icon / Delete Action -->
                                             <div class="flex items-center gap-1">
                                                 <i x-show="dest.type === 'youtube_auto'" class="fa-brands fa-youtube text-red-600 mr-1"></i>

                                                 <!-- Show Key Toggle -->
                                                 <button @click.stop="showKey = !showKey" class="p-1.5 text-gray-400 hover:text-blue-600 rounded-lg transition" title="Show/Hide Key">
                                                     <i class="fa-solid" :class="showKey ? 'fa-eye-slash' : 'fa-eye'"></i>
                                                 </button>

                                                 <!-- Delete Button -->
                                                 <button @click.stop="removeDestination(dest.id)" class="p-1.5 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition" title="Remove Destination">
                                                     <i class="fa-solid fa-trash-can"></i>
                                                 </button>
                                             </div>
                                         </div>
                                     </template>
                                </div>
                                <button @click="window.openAddDestinationChoiceModal()" class="mt-3 w-full py-2 text-sm text-blue-600 font-medium bg-blue-50 rounded-lg hover:bg-blue-100 transition">
                                    + Add Destination
                                </button>
                            </section>

                            <!-- Broadcast Info -->
                            <section>
                                <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Broadcast Info</h4>
                                <div class="space-y-3">
                                    <div>
                                        <div class="flex justify-between mb-1">
                                            <label class="block text-xs font-medium text-gray-700">Title</label>
                                            <button id="ai-btn-title" @click="generateMetadata('title')" class="text-xs text-blue-600 hover:text-blue-700 flex items-center gap-1"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C12.5 7.5 16.5 11.5 22 12C16.5 12.5 12.5 16.5 12 22C11.5 16.5 7.5 12.5 2 12C7.5 11.5 11.5 7.5 12 2Z"/></svg> AI Magic</button>
                                        </div>
                                        <input type="text" maxlength="100" x-model="streamTitle" class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition" placeholder="Stream Title">
                                    </div>
                                    <div>
                                        <div class="flex justify-between mb-1">
                                            <label class="block text-xs font-medium text-gray-700">Description</label>
                                            <button id="ai-btn-desc" @click="generateMetadata('desc')" class="text-xs text-blue-600 hover:text-blue-700 flex items-center gap-1"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C12.5 7.5 16.5 11.5 22 12C16.5 12.5 12.5 16.5 12 22C11.5 16.5 7.5 12.5 2 12C7.5 11.5 11.5 7.5 12 2Z"/></svg> AI Magic</button>
                                        </div>
                                        <textarea maxlength="5000" x-model="streamDescription" rows="3" class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition" placeholder="Description"></textarea>
                                    </div>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">Privacy <i class="fa-solid fa-circle-info text-gray-400 ml-1" title="Who can see your stream"></i></label>
                                            <select x-model="streamPrivacy" class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm">
                                                <option value="public">Public</option>
                                                <option value="unlisted">Unlisted</option>
                                                <option value="private">Private</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">Quality <i class="fa-solid fa-circle-info text-gray-400 ml-1" title="Stream output resolution"></i></label>
                                            <select x-model="streamQuality" class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm">
                                                <option value="1080">1080p</option>
                                                <option value="720">720p</option>
                                                <option value="2160">4K</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Overlay Settings -->
                                    <div class="mt-4 pt-3 border-t border-gray-100">
                                        <div class="flex items-center justify-between mb-2">
                                            <label class="text-xs font-bold text-gray-700 uppercase tracking-wider">Subscriber Overlay</label>
                                            <label class="switch scale-75">
                                                <input type="checkbox" x-model="overlayEnabled">
                                                <span class="slider round"></span>
                                            </label>
                                        </div>
                                        <div x-show="overlayEnabled" class="space-y-2">
                                            <label class="block text-xs font-medium text-gray-700">Template</label>
                                            <select x-model="overlayTemplate" class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm">
                                                <option value="SIMPLE">Simple (Bottom Left)</option>
                                                <option value="GOAL">Goal (10K)</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- AI Auto-Reply -->
                                    <div class="mt-4 pt-3 border-t border-gray-100">
                                        <div class="flex items-center justify-between mb-2">
                                            <label class="text-xs font-bold text-gray-700 uppercase tracking-wider">
                                                AI Auto-Reply <span class="text-[10px] bg-purple-100 text-purple-600 px-1 rounded ml-1">Experimental</span>
                                            </label>
                                            <label class="switch scale-75">
                                                <input type="checkbox" x-model="autoReplyEnabled">
                                                <span class="slider round"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </section>
                        </div>

                        <!-- STREAMS TAB -->
                        <div x-show="activeTab === 'streams'" class="space-y-4">
                            <div x-show="activeStreams.length === 0" class="text-center py-12">
                                <div class="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-3 text-gray-300">
                                    <i class="fa-solid fa-tower-broadcast text-2xl"></i>
                                </div>
                                <p class="text-gray-500 text-sm">No active streams</p>
                            </div>

                            <template x-for="stream in activeStreams" :key="stream.id">
                                <div class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm hover:shadow-md transition group">
                                    <div class="flex items-start gap-3">
                                        <div class="w-10 h-10 rounded-full bg-red-50 text-red-600 flex items-center justify-center shrink-0">
                                            <i class="fa-solid fa-satellite-dish animate-pulse"></i>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <h4 class="font-semibold text-sm text-gray-900 truncate" x-text="stream.title || 'Live Stream'"></h4>
                                            <div class="text-[10px] text-blue-600 font-medium truncate" x-show="stream.destinationName" x-text="stream.destinationName"></div>
                                            <p class="text-xs text-gray-500 mt-0.5" x-text="getStreamDuration(stream.startTime)"></p>
                                            <div class="mt-3 flex items-center gap-2">
                                                <button @click="stopStream(stream.id)" class="px-3 py-1.5 bg-red-50 text-red-600 rounded-lg text-xs font-medium hover:bg-red-100 transition flex items-center gap-1">
                                                    <i class="fa-solid fa-stop"></i> End
                                                </button>
                                                <button @click="setEndTime(stream.id)" class="px-3 py-1.5 bg-gray-50 text-gray-600 rounded-lg text-xs font-medium hover:bg-gray-100 transition flex items-center gap-1" title="Set End Time">
                                                    <i class="fa-regular fa-clock"></i> Stop At
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <!-- AUDIO TAB -->
                        <div x-show="activeTab === 'audio'" class="space-y-6">
                            <section>
                                 <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Audio & Music</h4>

                                 <!-- Audio Sub-Tabs -->
                                 <div class="flex gap-2 mb-4">
                                     <button @click="audioTab = 'upload'" class="px-3 py-1 text-xs rounded-full border transition" :class="audioTab === 'upload' ? 'bg-gray-900 text-white border-gray-900' : 'text-gray-600 border-gray-200'">Upload</button>
                                     <button @click="audioTab = 'lib'" class="px-3 py-1 text-xs rounded-full border transition" :class="audioTab === 'lib' ? 'bg-gray-900 text-white border-gray-900' : 'text-gray-600 border-gray-200'">Stock</button>
                                     <button @click="audioTab = 'mylib'" class="px-3 py-1 text-xs rounded-full border transition" :class="audioTab === 'mylib' ? 'bg-gray-900 text-white border-gray-900' : 'text-gray-600 border-gray-200'">My Library</button>
                                 </div>

                                 <!-- Upload -->
                                 <div x-show="audioTab === 'upload'">
                                     <div class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center hover:bg-gray-50 transition cursor-pointer relative">
                                         <input type="file" class="absolute inset-0 opacity-0 cursor-pointer" accept=".mp3,.wav" @change="handleMusicUpload($event)">
                                         <i class="fa-solid fa-cloud-arrow-up text-gray-400 text-2xl mb-2"></i>
                                         <p class="text-xs text-gray-500" x-text="uploadedMusicName || 'Click to upload mp3'"></p>
                                     </div>
                                 </div>

                                 <!-- Stock -->
                                 <div x-show="audioTab === 'lib'" class="space-y-2 max-h-60 overflow-y-auto">
                                     <template x-for="track in stockTracks" :key="track.id">
                                         <div @click="selectedStockId = track.id" class="flex items-center justify-between p-2 rounded-lg cursor-pointer hover:bg-gray-50"
                                             :class="selectedStockId === track.id ? 'bg-blue-50' : ''">
                                             <div class="flex items-center gap-2 overflow-hidden">
                                                 <i class="fa-solid fa-music text-gray-400 text-xs"></i>
                                                 <span class="text-xs font-medium truncate" x-text="track.title"></span>
                                             </div>
                                             <button @click.stop="previewAudio(track.url)" class="w-6 h-6 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 text-xs">
                                                 <i class="fa-solid" :class="playingUrl === track.url ? 'fa-pause' : 'fa-play'"></i>
                                             </button>
                                         </div>
                                     </template>
                                 </div>

                                 <!-- My Library -->
                                 <div x-show="audioTab === 'mylib'" class="space-y-2 max-h-60 overflow-y-auto">
                                     <template x-for="track in libraryTracks" :key="track.id">
                                         <div @click="selectedLibraryMusicName = track.title" class="flex items-center justify-between p-2 rounded-lg cursor-pointer hover:bg-gray-50"
                                             :class="selectedLibraryMusicName === track.title ? 'bg-blue-50' : ''">
                                             <div class="flex items-center gap-2 overflow-hidden">
                                                 <i class="fa-solid fa-file-audio text-gray-400 text-xs"></i>
                                                 <span class="text-xs font-medium truncate" x-text="track.title"></span>
                                             </div>
                                             <button @click.stop="previewAudio('/api/library/stream/' + track.id)" class="w-6 h-6 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 text-xs">
                                                 <i class="fa-solid" :class="playingUrl === '/api/library/stream/' + track.id ? 'fa-pause' : 'fa-play'"></i>
                                             </button>
                                         </div>
                                     </template>
                                 </div>

                                 <!-- Volume -->
                                 <div class="mt-4">
                                     <div class="flex justify-between text-xs mb-2 text-gray-600">
                                         <span>Music Volume</span>
                                         <span x-text="musicVolume + '%'"></span>
                                     </div>
                                     <input type="range" x-model="musicVolume" min="0" max="100" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                                 </div>

                            </section>
                        </div>

                        <!-- BRAND TAB -->
                        <div x-show="activeTab === 'brand'" class="space-y-6">
                            <section>
                                <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Branding</h4>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-2">Watermark / Logo</label>
                                    <div class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center hover:bg-gray-50 transition cursor-pointer relative">
                                         <input type="file" id="streamWatermarkFile" class="absolute inset-0 opacity-0 cursor-pointer" accept=".png,.jpg" onchange="window.handleWatermarkUpload(this)">
                                         <i class="fa-solid fa-image text-gray-400 text-2xl mb-2"></i>
                                         <p class="text-xs text-gray-500">Upload PNG/JPG</p>
                                    </div>
                                    <div id="watermarkPreview" class="hidden mt-3 p-2 bg-blue-50 rounded-lg flex items-center justify-between">
                                        <img id="watermarkImg" src="" class="h-8 object-contain">
                                        <button onclick="window.clearWatermark()" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-xmark"></i></button>
                                    </div>
                                </div>
                            </section>
                        </div>


                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: CALENDAR (Alpine + Tailwind) -->
        <div id="view-calendar" class="view-section hidden bg-gray-50 font-sans" x-data="contentStudio" x-init="initCalendar()">
            <div class="max-w-6xl mx-auto h-full flex flex-col">
                <header class="mb-8">
                    <h1 class="text-3xl font-bold text-gray-900 tracking-tight">Content Calendar</h1>
                    <p class="text-gray-500 mt-1">Visualize and plan your upcoming content strategy.</p>
                </header>

                <div class="flex-1 bg-white rounded-2xl shadow-sm border border-gray-200 p-6 overflow-hidden flex flex-col">
                    <div id="calendar" class="flex-1"></div>
                </div>
            </div>
        </div>

        <!-- VIEW: COMMUNITY -->
        <div id="view-community" class="view-section hidden" style="padding: 20px;">
            <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                 <h2 style="margin:0;">Engagement</h2>
                 <button class="btn btn-outline btn-sm" onclick="showEngagementSettings()"><i class="fa-solid fa-robot"></i> AI Automation</button>
            </div>

            <div class="community-grid-layout flex flex-col lg:grid lg:grid-cols-[240px_350px_1fr]">
                <!-- SIDEBAR -->
                <div class="comm-sidebar hidden lg:block">
                    <div class="comm-nav-item active" onclick="filterCommTab('all')">
                        <i class="fa-solid fa-inbox"></i> All Comments
                    </div>
                    <div class="comm-nav-item" onclick="filterCommTab('unreplied')">
                        <i class="fa-regular fa-envelope-open"></i> Unreplied
                    </div>
                    <div style="margin: 15px 20px 5px; font-size: 0.75rem; font-weight: 700; color: #999; text-transform: uppercase;">Activity</div>
                    <div class="comm-nav-item" onclick="filterCommTab('activity')">
                        <i class="fa-solid fa-bolt"></i> Auto-Actions
                    </div>
                </div>

                <!-- LIST -->
                <div id="commListPanel" class="comm-list-panel h-full overflow-y-auto border-b lg:border-b-0 lg:border-r border-gray-200">
                     <div style="padding: 15px; border-bottom: 1px solid var(--border);">
                         <input type="text" placeholder="Search..." class="form-input" style="font-size: 0.9rem;">
                     </div>
                     <div id="threadList" class="thread-list">
                         <!-- Populated via JS -->
                     </div>
                </div>

                <!-- ACTIVITY VIEW (Alternative to List/Detail) -->
                <div id="commActivityView" class="comm-detail-panel hidden" style="padding: 30px; overflow-y: auto; grid-column: span 2;">
                    <h3 style="margin-top:0;">Automation Log</h3>
                    <div id="activityList" class="activity-list"></div>
                </div>

                <!-- DETAIL -->
                <div id="commDetailView" class="comm-detail-panel">
                    <div id="emptyThreadState" class="empty-state" style="padding-top: 100px;">
                        <i class="fa-regular fa-comments"></i>
                        <p>Select a conversation to reply</p>
                    </div>

                    <div id="activeThread" class="hidden" style="display: flex; flex-direction: column; height: 100%;">
                        <div class="thread-header" style="padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #fafafa;">
                             <div style="font-weight: 600; font-size: 0.95rem; display: flex; align-items: center; gap: 8px;">
                                 <i class="fa-brands fa-youtube" style="color: red;"></i>
                                 <span id="threadVideoTitle">Video Title</span>
                             </div>
                             <a href="#" id="threadVideoLink" target="_blank" style="color: var(--text-muted);"><i class="fa-solid fa-external-link"></i></a>
                        </div>

                        <div id="threadMessages" class="thread-messages" style="flex: 1; overflow-y: auto; padding: 20px;">
                            <!-- Bubbles -->
                        </div>

                        <!-- AI Suggestions Area -->
                        <div id="aiSuggestionsArea" class="hidden" style="padding: 10px 20px; background: #f0f8ff; border-top: 1px solid #cce0ff;">
                            <small style="font-weight:600; color:#0052cc; display:block; margin-bottom:8px;">AI Suggestions:</small>
                            <div id="aiChips" style="display:flex; gap:8px; flex-wrap:wrap;"></div>
                            <button class="btn btn-sm btn-text" onclick="generateSuggestions()" style="font-size:0.8rem; margin-top:5px; padding-left:0;"><i class="fa-solid fa-rotate"></i> Refresh</button>
                        </div>

                        <div class="reply-box" style="padding: 20px; border-top: 1px solid var(--border); background: white;">
                            <textarea id="replyInput" placeholder="Write a reply..." rows="3" class="form-input" style="margin-bottom: 10px;"></textarea>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <button class="btn btn-sm btn-outline" onclick="toggleAiSuggestions()"><i class="fa-solid fa-wand-magic-sparkles" style="color: #8e44ad;"></i> AI Assist</button>
                                <button class="btn btn-primary" onclick="sendReply()">Reply</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: ANALYTICS -->
        <div id="view-analytics" class="view-section hidden">
             <header class="page-header">
                <h1>Analytics</h1>
                <select id="analyticsRange" class="form-select" onchange="initAnalytics()">
                    <option value="7">Last 7 Days</option>
                    <option value="28" selected>Last 28 Days</option>
                    <option value="90">Last 90 Days</option>
                    <option value="365">Last Year</option>
                </select>
            </header>

            <div class="summary-grid">
                 <div class="card summary-card">
                     <h3>Views</h3>
                     <p id="totalViews">0</p>
                 </div>
                 <div class="card summary-card">
                     <h3>Subscribers</h3>
                     <p id="totalSubs">0</p>
                 </div>
                 <div class="card summary-card">
                     <h3>Watch Time</h3>
                     <p id="totalWatchTime">0</p>
                 </div>
             </div>
             <div class="card chart-card">
                 <canvas id="analyticsChart"></canvas>
             </div>
        </div>

        <!-- VIEW: LIBRARY (Alpine + Tailwind) -->
        <div id="view-library" class="view-section hidden bg-gray-50/50 font-sans" x-data="contentStudio" x-init="loadLibrary()">
            <div class="max-w-[1600px] mx-auto h-full flex flex-col">
                <header class="mb-6 flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900 tracking-tight">Media Library</h1>
                        <p class="text-gray-500 mt-1">Manage, optimize, and schedule your video assets.</p>
                    </div>

                    <div class="flex items-center gap-3 flex-wrap">
                        <button onclick="openYouTubeImportModal()" class="bg-white border border-gray-200 text-gray-700 font-medium py-2 px-4 rounded-lg hover:bg-gray-50 hover:border-gray-300 transition flex items-center gap-2 shadow-sm">
                            <i class="fa-brands fa-youtube text-red-600"></i> Import
                        </button>
                        <button onclick="document.getElementById('bulkUploadInput').click()" class="bg-white border border-gray-200 text-gray-700 font-medium py-2 px-4 rounded-lg hover:bg-gray-50 hover:border-gray-300 transition flex items-center gap-2 shadow-sm">
                            <i class="fa-solid fa-cloud-arrow-up"></i> Upload
                        </button>
                        <input type="file" id="bulkUploadInput" multiple hidden accept="video/*,.zip">
                        <div class="w-px h-8 bg-gray-200 mx-1"></div>
                        <button class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-sm shadow-blue-500/30 transition flex items-center gap-2" onclick="showAutoScheduleModal()">
                            <i class="fa-solid fa-wand-magic-sparkles"></i> Auto-Schedule
                        </button>
                    </div>
                </header>

                <!-- Selection Toolbar (Visible when items selected) -->
                <div x-show="selectedVideos.size > 0"
                     class="bg-blue-600 text-white px-6 py-3 rounded-xl mb-6 flex items-center justify-between shadow-lg shadow-blue-600/20 animate-fade-in"
                     style="display:none;">
                    <div class="flex items-center gap-4 font-medium">
                        <span x-text="selectedVideos.size + ' selected'"></span>
                        <div class="w-px h-4 bg-white/20"></div>
                        <button @click="toggleSelectAll()" class="text-white/80 hover:text-white text-sm">Select All</button>
                    </div>
                    <div class="flex items-center gap-3">
                        <button @click="mergeSelected()" class="bg-white/10 hover:bg-white/20 px-3 py-1.5 rounded-lg text-sm transition border border-white/10 flex items-center gap-2">
                            <i class="fa-solid fa-object-group"></i> Merge
                        </button>
                        <button @click="deleteSelected()" class="bg-red-500 hover:bg-red-600 px-3 py-1.5 rounded-lg text-sm transition shadow-sm flex items-center gap-2">
                            <i class="fa-solid fa-trash"></i> Delete
                        </button>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="flex-1 overflow-y-auto">
                    <!-- Loading State -->
                    <div x-show="isLoadingLibrary" class="text-center py-20 text-gray-500">
                        <div class="afk-loader mb-4"></div>
                        <p>Loading your library...</p>
                    </div>

                    <!-- Empty State -->
                    <div x-show="!isLoadingLibrary && libraryVideos.length === 0" class="text-center py-24 bg-white rounded-3xl border border-dashed border-gray-300">
                        <div class="w-20 h-20 bg-gray-50 text-gray-400 rounded-full flex items-center justify-center mx-auto mb-6">
                            <i class="fa-solid fa-film text-3xl"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-900">Library is empty</h3>
                        <p class="text-gray-500 mt-2 mb-6">Upload videos to start streaming or scheduling.</p>
                        <button onclick="document.getElementById('bulkUploadInput').click()" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-6 rounded-full transition shadow-lg shadow-blue-500/30">
                            Upload Video
                        </button>
                    </div>

                    <!-- Video Grid -->
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 pb-20" x-show="!isLoadingLibrary && libraryVideos.length > 0">
                        <template x-for="video in libraryVideos" :key="video.id">
                            <div class="group relative bg-white rounded-2xl border border-gray-200 shadow-sm hover:shadow-xl transition-all duration-300 hover:-translate-y-1 overflow-hidden"
                                :class="isSelected(video) ? 'ring-2 ring-blue-500 border-transparent' : ''">

                                <!-- Selection Checkbox (Absolute) -->
                                <div class="absolute top-3 left-3 z-10">
                                    <input type="checkbox"
                                           class="w-5 h-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer shadow-sm"
                                           :checked="isSelected(video)"
                                           @change="toggleSelection(video)">
                                </div>

                                <!-- Thumbnail / Preview -->
                                <div class="aspect-video bg-gray-100 relative overflow-hidden cursor-pointer" @click="previewVideo(video)">
                                    <template x-if="video.thumbnailS3Key">
                                        <img :src="`/api/videos/${video.id}/thumbnail`" class="w-full h-full object-cover transition duration-500 group-hover:scale-105">
                                    </template>
                                    <template x-if="!video.thumbnailS3Key">
                                        <div class="w-full h-full flex items-center justify-center text-gray-300 bg-gray-50">
                                            <i class="fa-solid fa-clapperboard text-3xl opacity-50"></i>
                                        </div>
                                    </template>

                                    <!-- Duration/Size Badge -->
                                    <div class="absolute bottom-2 right-2 bg-black/60 backdrop-blur-sm text-white text-[10px] font-bold px-1.5 py-0.5 rounded">
                                        <span x-text="(video.fileSize / 1024 / 1024).toFixed(1) + ' MB'"></span>
                                    </div>

                                    <!-- Optimized Badge -->
                                    <div x-show="video.optimizationStatus === 'COMPLETED'" class="absolute top-3 right-3 bg-green-500/90 text-white text-[10px] font-bold px-2 py-1 rounded-full shadow-sm backdrop-blur-sm">
                                        OPTIMIZED
                                    </div>

                                    <!-- Progress Bar -->
                                    <div x-show="video.optimizationStatus === 'IN_PROGRESS'" class="absolute inset-0 bg-black/60 backdrop-blur-sm flex flex-col items-center justify-center p-4 z-20">
                                        <p class="text-white text-xs font-bold mb-2">Optimizing...</p>
                                        <div class="w-full h-1.5 bg-gray-700 rounded-full overflow-hidden">
                                            <div class="h-full bg-blue-500 transition-all duration-300" :style="`width: ${video.progress || 0}%`"></div>
                                        </div>
                                        <p class="text-gray-300 text-[10px] mt-1" x-text="`${video.progress || 0}%`"></p>
                                    </div>
                                </div>

                                <!-- Info Body -->
                                <div class="p-4">
                                    <h4 class="font-semibold text-gray-900 text-sm truncate mb-1" x-text="video.title" :title="video.title"></h4>
                                    <div class="flex justify-between items-center mt-3">

                                        <!-- Optimize Action -->
                                        <button x-show="video.optimizationStatus !== 'COMPLETED' && video.optimizationStatus !== 'IN_PROGRESS'"
                                                class="text-xs font-medium text-blue-600 hover:text-blue-700 transition flex items-center gap-1 bg-blue-50 hover:bg-blue-100 px-2 py-1 rounded"
                                                @click.stop="window.openOptimizeModal(video)">
                                            <i class="fa-solid fa-wand-magic-sparkles"></i> Optimize
                                        </button>

                                        <button class="text-xs font-medium text-gray-500 hover:text-blue-600 transition flex items-center gap-1 ml-auto" @click.stop="scheduleFromLibrary(video.id, video.title)">
                                            <i class="fa-regular fa-calendar-plus"></i>
                                        </button>

                                        <button class="text-gray-400 hover:text-red-500 transition p-1 rounded-md hover:bg-red-50 ml-2" @click.stop="deleteLibraryVideo(video.id, video.title)">
                                            <i class="fa-solid fa-trash text-xs"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: SETTINGS (Alpine + Tailwind) -->
        <div id="view-settings" class="view-section hidden bg-gray-50/50" x-data="settingsStudio">
            <div class="max-w-5xl h-full flex flex-col">
                <header class="mb-8">
                    <h1 class="text-3xl font-bold text-gray-900 tracking-tight">Settings</h1>
                    <p class="text-gray-500 mt-1">Manage your account, channels, and subscription.</p>
                </header>

                <div class="flex flex-col lg:flex-row gap-4 lg:gap-6 flex-1 min-h-0">
                    <!-- SIDEBAR NAV -->
                    <nav class="w-full lg:w-64 flex-shrink-0 space-y-1">
                        <template x-for="item in [
                            {id: 'general', icon: 'fa-user', label: 'General'},
                            {id: 'channels', icon: 'fa-share-nodes', label: 'Channels'},
                            {id: 'plans', icon: 'fa-credit-card', label: 'Plans'},
                            {id: 'usage', icon: 'fa-file-invoice-dollar', label: 'Billing'}
                        ]">
                            <button @click="switchTab(item.id)"
                                class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium transition-all duration-200"
                                :class="activeTab === item.id ? 'bg-white text-blue-600 shadow-sm ring-1 ring-gray-200' : 'text-gray-600 hover:bg-gray-100 hover:text-gray-900'">
                                <i class="fa-solid w-5 text-center" :class="item.icon"></i>
                                <span x-text="item.label"></span>
                            </button>
                        </template>
                    </nav>

                    <!-- CONTENT AREA -->
                    <div class="flex-1 min-w-0 bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden flex flex-col">

                        <!-- TAB: GENERAL -->
                        <div x-show="activeTab === 'general'" class="p-8 space-y-8 animate-fade-in">
                            <section>
                                <h3 class="text-lg font-semibold text-gray-900 mb-4">Account Information</h3>
                                <div class="bg-gray-50 rounded-xl p-6 border border-gray-100 flex items-center gap-6">
                                    <div class="w-20 h-20 rounded-full bg-gray-200 overflow-hidden ring-4 ring-white shadow-sm">
                                        <img :src="user?.picture" class="w-full h-full object-cover">
                                    </div>
                                    <div class="flex-1">
                                        <div class="text-xl font-bold text-gray-900" x-text="user?.name || 'User'"></div>
                                        <div class="text-sm text-gray-500" x-text="user?.email"></div>
                                        <div class="mt-2 flex items-center gap-2">
                                             <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                                <span x-text="user?.plan?.name || 'Free Plan'"></span>
                                             </span>
                                        </div>
                                    </div>
                                </div>
                            </section>

                            <section>
                                <h3 class="text-lg font-semibold text-gray-900 mb-4">Linked Accounts</h3>
                                <div class="bg-white border border-gray-200 rounded-xl p-4 flex items-center justify-between hover:bg-gray-50 transition">
                                    <div class="flex items-center gap-4">
                                        <div class="w-10 h-10 rounded-full bg-white border border-gray-200 flex items-center justify-center">
                                            <i class="fa-brands fa-google text-xl"></i>
                                        </div>
                                        <div>
                                            <div class="font-medium text-gray-900">Google Account</div>
                                            <div class="text-xs text-gray-500">Used for login and YouTube access</div>
                                        </div>
                                    </div>
                                    <a href="/oauth2/authorization/google" class="text-sm font-medium text-gray-600 hover:text-gray-900 border border-gray-300 px-3 py-1.5 rounded-lg hover:bg-gray-100 transition">
                                        Reconnect
                                    </a>
                                </div>
                            </section>
                        </div>

                        <!-- TAB: CHANNELS -->
                        <div x-show="activeTab === 'channels'" class="p-8 flex flex-col h-full animate-fade-in">
                            <div class="flex justify-between items-center mb-6">
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900">Social Channels</h3>
                                    <p class="text-sm text-gray-500">Manage your connected streaming destinations.</p>
                                </div>
                                <button @click="openConnectModal()" class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium px-4 py-2 rounded-lg transition shadow-sm shadow-blue-500/30 flex items-center gap-2">
                                    <i class="fa-solid fa-plus"></i> Connect Channel
                                </button>
                            </div>

                            <div class="space-y-3">
                                <template x-if="channels.length === 0">
                                    <div class="text-center py-12 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200">
                                        <i class="fa-solid fa-share-nodes text-4xl text-gray-300 mb-3"></i>
                                        <p class="text-gray-500 font-medium">No channels connected</p>
                                        <button @click="openConnectModal()" class="mt-2 text-blue-600 hover:text-blue-700 text-sm font-medium">Connect one now</button>
                                    </div>
                                </template>

                                <template x-for="channel in channels" :key="channel.id">
                                    <div class="group flex items-center gap-4 p-4 rounded-xl border border-gray-200 hover:border-blue-300 hover:bg-blue-50/50 transition bg-white">
                                        <div class="w-12 h-12 rounded-lg bg-gray-100 overflow-hidden border border-gray-200">
                                            <img :src="channel.profileUrl" class="w-full h-full object-cover">
                                        </div>
                                        <div class="flex-1">
                                            <h4 class="font-bold text-gray-900" x-text="channel.name"></h4>
                                            <div class="flex items-center gap-2 mt-0.5">
                                                <span class="text-xs font-medium px-2 py-0.5 rounded bg-gray-100 text-gray-600 uppercase" x-text="channel.platform"></span>
                                            </div>
                                        </div>
                                        <button @click="removeChannel(channel.id)" class="opacity-0 group-hover:opacity-100 transition p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg" title="Disconnect">
                                            <i class="fa-solid fa-trash-can"></i>
                                        </button>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- TAB: PLANS & BILLING -->
                        <div x-show="activeTab === 'plans'" class="p-8 animate-fade-in space-y-8 overflow-y-auto">

                            <!-- Current Usage -->
                            <section>
                                <h3 class="text-lg font-semibold text-gray-900 mb-4">Current Usage</h3>
                                <div class="bg-gray-900 text-white rounded-2xl p-6 shadow-lg shadow-gray-200 overflow-hidden relative">
                                    <div class="absolute top-0 right-0 p-32 bg-blue-500 rounded-full blur-3xl opacity-20 -mr-16 -mt-16"></div>

                                    <div class="relative z-10 flex flex-col md:flex-row justify-between md:items-end gap-6">
                                        <div>
                                            <div class="text-blue-200 font-medium text-sm uppercase tracking-wider mb-1">Current Plan</div>
                                            <div class="text-3xl font-bold" x-text="user?.plan?.name || 'Free'"></div>
                                            <div class="mt-4 flex items-center gap-2 text-sm text-gray-300">
                                                <i class="fa-solid fa-hard-drive"></i>
                                                <span>Storage Used: <span x-text="formattedStorage"></span></span>
                                            </div>
                                            <div class="mt-1 flex items-center gap-2 text-sm text-gray-300">
                                                <i class="fa-regular fa-calendar-check"></i>
                                                <span>Expires: <span x-text="planExpirationDisplay"></span></span>
                                            </div>
                                        </div>
                                        <div class="w-full md:w-64">
                                            <div class="flex justify-between text-xs mb-2 text-gray-400">
                                                <span>Capacity</span>
                                                <span x-text="storagePercentage.toFixed(0) + '%'"></span>
                                            </div>
                                            <div class="w-full h-2 bg-gray-700 rounded-full overflow-hidden">
                                                <div class="h-full bg-blue-500 rounded-full transition-all duration-500" :style="`width: ${storagePercentage}%`"></div>
                                            </div>
                                            <button @click="cancelSubscription()" class="mt-4 text-xs text-red-400 hover:text-red-300 font-medium transition">
                                                Cancel Subscription
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </section>

                            <!-- Upgrade Options -->
                            <section>
                                <h3 class="text-lg font-semibold text-gray-900 mb-4">Available Plans</h3>
                                <div x-show="isLoading" class="text-center py-8 text-gray-500">
                                    <div class="afk-loader mb-2"></div>
                                    <p>Loading plans...</p>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <template x-for="plan in plans" :key="plan.id">
                                        <div class="border rounded-2xl p-6 flex flex-col hover:shadow-lg transition duration-200 hover:-translate-y-1 bg-white relative overflow-hidden"
                                            :class="user?.plan?.name === plan.title ? 'border-blue-500 ring-1 ring-blue-500' : 'border-gray-200'">

                                            <div x-show="user?.plan?.name === plan.title" class="absolute top-0 right-0 bg-blue-500 text-white text-[10px] font-bold px-2 py-1 rounded-bl-lg">
                                                CURRENT
                                            </div>

                                            <h4 class="text-lg font-bold text-gray-900" x-text="plan.title"></h4>
                                            <div class="mt-2 mb-4">
                                                <span class="text-3xl font-bold text-gray-900" x-text="plan.price"></span>
                                                <span class="text-sm text-gray-500" x-text="plan.period"></span>
                                            </div>

                                            <ul class="space-y-3 mb-8 flex-1">
                                                <!-- Mock features based on plan title -->
                                                <li class="flex items-start gap-2 text-sm text-gray-600">
                                                    <i class="fa-solid fa-check text-blue-500 mt-0.5"></i>
                                                    <span x-text="(plan.title === 'Free' ? '500MB' : (plan.title === 'Pro' ? '10GB' : '50GB')) + ' Storage'"></span>
                                                </li>
                                                <li class="flex items-start gap-2 text-sm text-gray-600">
                                                    <i class="fa-solid fa-check text-blue-500 mt-0.5"></i>
                                                    <span>Unlimited Streaming</span>
                                                </li>
                                            </ul>

                                            <button @click="openPayment(plan)"
                                                class="w-full py-2 rounded-lg font-semibold transition"
                                                :class="(user?.plan?.name === plan.title || (user?.plan?.name !== 'Free' && plan.title === 'Free')) ? 'bg-gray-100 text-gray-500 cursor-default' : 'bg-blue-600 hover:bg-blue-700 text-white shadow-sm shadow-blue-500/30'"
                                                :disabled="user?.plan?.name === plan.title || (user?.plan?.name !== 'Free' && plan.title === 'Free')"
                                                x-text="user?.plan?.name === plan.title ? 'Active' : (user?.plan?.name !== 'Free' && plan.title === 'Free' ? 'Included' : 'Upgrade')">
                                            </button>
                                        </div>
                                    </template>
                                </div>
                            </section>
                        </div>

                        <!-- TAB: USAGE (BILLING) -->
                        <div x-show="activeTab === 'usage'" class="p-8 animate-fade-in space-y-8 overflow-y-auto">
                            <section>
                                <h3 class="text-lg font-semibold text-gray-900 mb-4">Pay As You Go Balance</h3>

                                <div class="bg-white border border-gray-200 rounded-2xl p-6 shadow-sm">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <p class="text-sm text-gray-500 uppercase tracking-wider font-medium">Unpaid Balance</p>
                                            <div class="text-4xl font-bold text-gray-900 mt-2" x-text="formatCurrency(user?.unpaidBalance || 0)">₹0.00</div>
                                            <p class="text-xs text-gray-400 mt-1" x-show="user?.creditLimit">Credit Limit: <span x-text="formatCurrency(user?.creditLimit)"></span></p>
                                        </div>

                                        <div class="text-right">
                                            <button @click="payBalance()"
                                                class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow-lg shadow-blue-500/30 transition transform active:scale-95"
                                                :disabled="(user?.unpaidBalance || 0) <= 0"
                                                :class="(user?.unpaidBalance || 0) <= 0 ? 'opacity-50 cursor-not-allowed' : ''">
                                                Pay Now
                                            </button>
                                            <p class="text-xs text-gray-400 mt-2" x-show="(user?.unpaidBalance || 0) > 0">Clear your balance to continue streaming</p>
                                        </div>
                                    </div>

                                    <div class="mt-6 pt-6 border-t border-gray-100">
                                        <h4 class="text-sm font-semibold text-gray-800 mb-3">Usage History</h4>
                                        <div class="overflow-x-auto">
                                            <table class="w-full text-left">
                                                <thead class="bg-gray-50 border-b border-gray-100">
                                                    <tr>
                                                        <th class="px-4 py-3 text-xs font-semibold text-gray-500 uppercase">Stream</th>
                                                        <th class="px-4 py-3 text-xs font-semibold text-gray-500 uppercase">Started</th>
                                                        <th class="px-4 py-3 text-xs font-semibold text-gray-500 uppercase">Ended</th>
                                                        <th class="px-4 py-3 text-xs font-semibold text-gray-500 uppercase">Duration</th>
                                                        <th class="px-4 py-3 text-xs font-semibold text-gray-500 uppercase text-right">Cost</th>
                                                    </tr>
                                                </thead>
                                                <tbody class="divide-y divide-gray-50">
                                                    <template x-for="job in usageHistory" :key="job.id">
                                                        <tr class="hover:bg-gray-50 transition">
                                                            <td class="px-4 py-3">
                                                                <div class="text-sm font-medium text-gray-900" x-text="job.title || 'Untitled Stream'"></div>
                                                                <div class="text-xs text-gray-500" x-text="job.destinationName || 'Unknown Destination'"></div>
                                                            </td>
                                                            <td class="px-4 py-3 text-sm text-gray-500" x-text="new Date(job.startTime).toLocaleString()"></td>
                                                            <td class="px-4 py-3 text-sm text-gray-500" x-text="job.endTime ? new Date(job.endTime).toLocaleString() : 'Live'"></td>
                                                            <td class="px-4 py-3 text-sm text-gray-500 font-mono" x-text="getDurationString(job.startTime, job.endTime)"></td>
                                                            <td class="px-4 py-3 text-sm font-medium text-gray-900 text-right" x-text="formatCurrency(job.accumulatedCost || 0)"></td>
                                                        </tr>
                                                    </template>
                                                    <tr x-show="!isLoading && usageHistory.length === 0">
                                                        <td colspan="5" class="px-4 py-8 text-center text-gray-500 text-sm">No usage history found.</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </section>
                        </div>

                    </div>
                </div>
            </div>

            <!-- PAYMENT CONFIRMATION MODAL (Alpine) -->
            <div x-show="paymentModalOpen" class="fixed inset-0 z-[100] bg-gray-900/50 backdrop-blur-sm flex items-center justify-center p-4" x-transition.opacity style="display:none;">
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 relative">
                    <button @click="paymentModalOpen = false" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>

                    <div class="text-center mb-6">
                        <div class="w-16 h-16 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fa-solid fa-rocket text-2xl"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900">Upgrade to <span x-text="selectedPlan?.title"></span></h3>
                        <p class="text-gray-500 text-sm mt-1">Unlock more storage and premium features.</p>
                    </div>

                    <div class="bg-gray-50 rounded-xl p-4 mb-6 border border-gray-100">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-medium text-gray-600">Total due today</span>
                            <span class="text-lg font-bold text-gray-900" x-text="selectedPlan?.price"></span>
                        </div>
                        <div class="flex items-center gap-2 text-xs text-gray-500">
                            <i class="fa-solid fa-lock"></i> Secure payment with PhonePe
                        </div>
                    </div>

                    <button @click="processUpgrade()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg shadow-blue-500/30 transition transform active:scale-95">
                        Confirm & Pay
                    </button>
                </div>
            </div>

        </div>

    </main>
</div>

<!-- MODALS -->

<!-- Optimize Video Modal -->
<div id="optimizeModal" class="modal-overlay hidden">
    <div class="modal-box" style="width: 450px;">
        <div class="modal-header" style="border:none;">
            <h2>Optimize Video</h2>
            <button onclick="document.getElementById('optimizeModal').classList.add('hidden')" class="btn-close"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <p style="color:#666; margin-bottom:20px;">Create an optimized version for streaming.</p>

        <div class="form-group">
            <label>Format</label>
            <div class="platform-select">
                <div class="platform-option selected" onclick="selectOptimizeMode('landscape', this)">
                    <i class="fa-solid fa-desktop"></i> Landscape (16:9)
                </div>
                <div class="platform-option" onclick="selectOptimizeMode('portrait', this)">
                    <i class="fa-solid fa-mobile-screen"></i> Portrait (9:16)
                </div>
            </div>
        </div>

        <div class="form-group">
            <label>Quality / Resolution</label>
            <select id="optimizeQuality" class="form-input">
                <option value="1080">1080p (Full HD)</option>
                <option value="720">720p (HD)</option>
                <option value="2160">4K (Ultra HD)</option>
            </select>
        </div>

        <input type="hidden" id="optimizeFileName">
        <input type="hidden" id="optimizeMode" value="landscape">

        <div class="modal-actions" style="margin-top: 20px; text-align: right;">
            <button class="btn btn-text" onclick="document.getElementById('optimizeModal').classList.add('hidden')">Cancel</button>
            <button class="btn btn-primary" onclick="submitOptimization()">Start Optimization</button>
        </div>
    </div>
</div>

<!-- Connect Channel Modal -->
<div id="connectChannelModal" class="modal-overlay hidden">
    <div class="modal-box" style="width: 450px;">
        <div class="modal-header" style="padding: 0 0 20px 0; border: none;">
            <h2>Connect Channel</h2>
            <button onclick="document.getElementById('connectChannelModal').classList.add('hidden')" class="btn-close"><i class="fa-solid fa-xmark"></i></button>
        </div>

        <div class="form-group">
            <label>Select Platform</label>
            <div class="platform-select">
                <div class="platform-option selected" onclick="selectPlatform('YOUTUBE', this)">
                    <i class="fa-brands fa-youtube" style="color: red;"></i> YouTube
                </div>
                <div class="platform-option" onclick="selectPlatform('INSTAGRAM', this)">
                    <i class="fa-brands fa-instagram" style="color: #E1306C;"></i> Instagram
                </div>
                <div class="platform-option" onclick="selectPlatform('SNAPCHAT', this)">
                    <i class="fa-brands fa-snapchat" style="color: #FFFC00; -webkit-text-stroke: 1px black;"></i> Snapchat
                </div>
            </div>
        </div>

        <div id="manualChannelInput" class="hidden">
            <div class="form-group">
                <label>Channel Name / Handle</label>
                <input type="text" id="connectChannelName" class="form-input" placeholder="@handle">
                <small style="color:#666">Enter your handle to link this account.</small>
            </div>
        </div>

        <div class="modal-actions" style="margin-top: 20px; text-align: right;">
            <button class="btn btn-text" onclick="document.getElementById('connectChannelModal').classList.add('hidden')">Cancel</button>
            <button id="btnConnect" class="btn btn-primary" onclick="submitConnectChannel()">Connect</button>
        </div>
    </div>
</div>

<!-- Preview Modal (Library) -->
<div id="previewModal" class="modal-overlay hidden">
    <div class="modal-box" style="width: 800px; max-width: 95vw; background: black; padding: 0;">
        <div style="position:relative; width:100%; aspect-ratio:16/9;">
            <video id="mainPreviewVideo" controls autoplay style="width:100%; height:100%; display:block;"></video>
            <button onclick="document.getElementById('previewModal').classList.add('hidden'); document.getElementById('mainPreviewVideo').pause();" style="position:absolute; top:10px; right:10px; background:rgba(0,0,0,0.5); border:none; color:white; border-radius:50%; width:32px; height:32px; cursor:pointer;">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
    </div>
</div>

<!-- Destination Choice Modal -->
<div id="destChoiceModal" class="modal-overlay hidden">
    <div class="modal-box" style="width: 550px;">
        <div class="modal-header" style="border:none; padding-bottom: 5px;">
            <h2 style="font-size: 1.2rem;">Login to YouTube or setup stream manually</h2>
            <button onclick="document.getElementById('destChoiceModal').classList.add('hidden')" class="btn-close"><i class="fa-solid fa-xmark"></i></button>
        </div>

        <div style="padding: 10px 0;">
            <!-- Dynamic Channel List Container -->
            <div id="ytChannelList">
                <!-- Populated via JS -->
            </div>

            <div id="defaultYtFetchOption" onclick="connectYouTubeDestination()" class="queue-item hidden" style="cursor: pointer; border: 2px solid var(--primary); background: #f0f7ff; margin-bottom: 15px;">
                <div style="background: white; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                    <i class="fa-brands fa-youtube" style="color: red; font-size: 1.5rem;"></i>
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: 700; font-size: 1.05rem; display: flex; align-items: center; gap: 10px; color: var(--primary-dark);">
                        Fetch from YouTube
                        <span style="background: var(--success); color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; font-weight: 600;">RECOMMENDED</span>
                    </div>
                    <div style="font-size: 0.9rem; color: var(--text-muted); margin-top: 4px;">Get Stream Key from connected account</div>
                </div>
                <i class="fa-solid fa-chevron-right" style="color: var(--primary);"></i>
            </div>

            <!-- Manual Option -->
            <div onclick="openManualDestinationModal()" class="queue-item" style="cursor: pointer;">
                 <div style="background: #f4f5f7; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;">
                    <i class="fa-solid fa-sliders" style="color: var(--text-muted); font-size: 1.2rem;"></i>
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: 700; font-size: 1.05rem; display: flex; align-items: center; gap: 10px;">
                        Manual setup
                        <span style="background: #eee; color: #666; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; font-weight: 600;">CLASSIC</span>
                    </div>
                    <div style="font-size: 0.9rem; color: var(--text-muted); margin-top: 4px;">Create and enter stream and key manually</div>
                </div>
                 <i class="fa-solid fa-chevron-right" style="color: var(--text-muted);"></i>
            </div>
        </div>
    </div>
</div>

<!-- Add Destination Modal (Manual) -->
<div id="addDestinationModal" class="modal-overlay hidden">
    <div class="modal-box" style="width: 400px;">
        <div class="modal-header" style="padding: 0 0 20px 0; border: none;">
            <h2>Add Destination</h2>
            <button onclick="document.getElementById('addDestinationModal').classList.add('hidden')" class="btn-close"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="form-group">
            <label>Name</label>
            <input type="text" id="newDestName" class="form-input" placeholder="e.g. YouTube Gaming">
        </div>
        <div class="form-group">
            <label>Stream Key</label>
            <div style="position: relative;">
                <input type="password" id="newDestKey" class="form-input" placeholder="rtmp://..." style="padding-right: 40px;">
                <button type="button" onclick="toggleStreamKeyVisibility('newDestKey', this)" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #666; cursor: pointer;">
                    <i class="fa-solid fa-eye"></i>
                </button>
            </div>
        </div>
        <div class="modal-actions" style="margin-top: 20px; text-align: right;">
            <button class="btn btn-text" onclick="document.getElementById('addDestinationModal').classList.add('hidden')">Cancel</button>
            <button class="btn btn-primary" onclick="submitDestination()">Save Destination</button>
        </div>
    </div>
</div>

<!-- Engagement Settings Modal -->
<div id="engagementSettingsModal" class="modal-overlay hidden">
    <div class="modal-box" style="width: 500px;">
        <div class="modal-header" style="border:none;">
            <h2>Engagement Automation</h2>
            <button onclick="document.getElementById('engagementSettingsModal').classList.add('hidden')" class="btn-close"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <p style="color:#666; margin-bottom:20px;">Automatically manage comments using AI (Gemini).</p>

        <div class="form-group" style="display:flex; align-items:center; justify-content:space-between; margin-bottom: 20px;">
            <div>
                <label style="margin:0; font-weight:600;">Auto-Like & Reply Positive</label>
                <div style="font-size:0.85rem; color:#888;">Like positive comments and reply with a smiley.</div>
            </div>
            <label class="switch">
                <input type="checkbox" id="engAutoReply">
                <span class="slider round"></span>
            </label>
        </div>

        <div class="form-group" style="display:flex; align-items:center; justify-content:space-between;">
            <div>
                <label style="margin:0; font-weight:600;">Delete Negative Comments</label>
                <div style="font-size:0.85rem; color:#888;">Automatically remove hate speech or negative sentiment.</div>
            </div>
            <label class="switch">
                <input type="checkbox" id="engDeleteNegative">
                <span class="slider round"></span>
            </label>
        </div>

        <div class="form-group" style="border-top:1px solid #eee; padding-top:15px; margin-top:15px;">
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom: 10px;">
                <div>
                    <label style="margin:0; font-weight:600;">Reply to Unreplied</label>
                    <div style="font-size:0.85rem; color:#888;">Auto-reply to all unreplied comments with a preset message.</div>
                </div>
                <label class="switch">
                    <input type="checkbox" id="engAutoReplyUnreplied" onchange="document.getElementById('engCustomMsgBox').classList.toggle('hidden', !this.checked)">
                    <span class="slider round"></span>
                </label>
            </div>

            <div id="engCustomMsgBox" class="hidden">
                <label style="font-size:0.85rem; font-weight:600; margin-bottom:5px; display:block;">Custom Message</label>
                <input type="text" id="engAutoReplyMessage" class="form-input" placeholder="e.g. Thanks for watching! 😊">
            </div>
        </div>

        <div class="modal-actions" style="text-align:right; margin-top:30px;">
            <button class="btn btn-primary" onclick="saveEngagementSettings()">Save Changes</button>
        </div>
    </div>
</div>

<!-- Internal Payment Modal -->
<div id="paymentModal" class="modal-overlay hidden">
    <div class="modal-box" style="width: 400px; text-align: center;">
        <h2>Confirm Subscription</h2>
        <p id="paymentPlanName" style="margin: 10px 0; font-size: 1.1rem; color: var(--primary);">Upgrade Plan</p>
        <div style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 8px; text-align: left;">
            <div style="display:flex; justify-content:space-between; margin-bottom: 10px;">
                <span>Total due today:</span>
                <strong id="paymentAmount">$0.00</strong>
            </div>
            <div style="font-size: 0.9rem; color: #666;">
                <i class="fa-solid fa-credit-card"></i> **** **** **** 4242
            </div>
        </div>
        <button id="btnConfirmPayment" class="btn btn-primary btn-block btn-lg" onclick="processPayment()">Pay & Upgrade</button>
        <button class="btn btn-text" onclick="document.getElementById('paymentModal').classList.add('hidden')" style="margin-top: 10px;">Cancel</button>
    </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmationModal" class="modal-overlay hidden">
    <div class="modal-box" style="width: 350px; text-align: center;">
        <i class="fa-solid fa-circle-exclamation" style="font-size: 3rem; color: #ffab00; margin-bottom: 15px;"></i>
        <h3 id="confirmTitle" style="margin: 0 0 10px 0;">Are you sure?</h3>
        <p id="confirmMessage" style="color: #666; font-size: 0.95rem; margin-bottom: 25px;">This action cannot be undone.</p>
        <div style="display: flex; gap: 10px; justify-content: center;">
            <button class="btn btn-outline" onclick="closeConfirmModal()">Cancel</button>
            <button id="btnConfirmAction" class="btn btn-danger">Confirm</button>
        </div>
    </div>
</div>

<!-- Support Modal -->
<div id="supportModal" class="modal-overlay hidden">
    <div class="modal-box" style="width: 400px;">
        <div class="modal-header" style="border:none;">
            <h2>Contact Support</h2>
            <button onclick="document.getElementById('supportModal').classList.add('hidden')" class="btn-close"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <p>Need help? Our team is available 24/7.</p>

        <div class="form-group">
            <label>Category</label>
            <select id="supportCategory" class="form-input">
                <option value="General">General Inquiry</option>
                <option value="Billing">Billing & Plans</option>
                <option value="Technical">Technical Issue</option>
                <option value="Feedback">Feature Request / Feedback</option>
            </select>
        </div>
        <div class="form-group">
            <label>Message</label>
            <textarea id="supportMessage" class="form-input" rows="4" placeholder="Describe your issue..."></textarea>
        </div>

        <div class="form-group">
            <label>Screenshot or Recording (Optional)</label>
            <input type="file" id="supportAttachment" class="form-input" accept="image/*,video/*,.pdf">
        </div>

        <button id="btnSubmitTicket" class="btn btn-primary btn-block" onclick="submitSupportTicket()">Submit Ticket</button>
        <button class="btn btn-text btn-block mt-2" onclick="document.getElementById('supportModal').classList.add('hidden')">Cancel</button>
    </div>
</div>

<!-- Schedule Modal -->
<div id="scheduleModal" class="modal-overlay hidden">
    <div class="modal-composer">
        <div class="modal-header">
            <h2>Create Post</h2>
            <button onclick="closeScheduleModal()" class="btn-close"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="modal-body">
            <div class="composer-grid">
                <div class="composer-main">
                    <!-- Step 1: Channel -->
                    <div class="form-group">
                        <label>Post to</label>
                        <div id="modalChannelSelector" class="channel-selector-row"></div>
                    </div>

                    <!-- Step 2: Content -->
                    <div class="form-group">
                        <textarea id="scheduleDescription" class="composer-textarea" placeholder="What would you like to share?"></textarea>
                        <div class="composer-tools">
                             <button class="tool-btn" onclick="aiGenerate('description')" title="AI Assist"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24" style="display:inline-block; vertical-align:middle; margin-right:4px;"><path d="M12 2C12.5 7.5 16.5 11.5 22 12C16.5 12.5 12.5 16.5 12 22C11.5 16.5 7.5 12.5 2 12C7.5 11.5 11.5 7.5 12 2Z"/></svg> AI Write</button>
                             <button class="tool-btn" onclick="document.getElementById('scheduleTags').focus()"><i class="fa-solid fa-hashtag"></i> Tags</button>
                        </div>
                    </div>

                    <div class="media-upload-area" id="dropZone">
                        <div id="mediaPlaceholder">
                            <i class="fa-regular fa-image"></i>
                            <span>Add Video</span>
                        </div>
                        <div id="selectedFileDisplay" class="hidden">
                            <i class="fa-solid fa-file-video"></i> <span id="fileName">video.mp4</span>
                        </div>
                        <input type="file" id="scheduleFile" accept="video/*" hidden>
                    </div>

                    <!-- Thumbnail Tools -->
                    <div id="thumbnailTools" class="hidden" style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px; display: flex; align-items: center; justify-content: space-between;">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <div id="thumbPreview" style="width: 60px; height: 34px; background: #ddd; border-radius: 4px; overflow: hidden; display: flex; align-items: center; justify-content: center;">
                                <i class="fa-regular fa-image"></i>
                            </div>
                            <span style="font-size: 0.9rem; font-weight: 500;">Thumbnail</span>
                        </div>
                        <div style="display:flex; gap:10px;">
                            <button class="btn btn-sm btn-outline" onclick="extractFrame()" title="Extract from Video"><i class="fa-solid fa-camera"></i> Auto</button>
                            <a href="https://www.canva.com/create/youtube-thumbnails/" target="_blank" class="btn btn-sm btn-outline" style="color: #5d26c9; border-color: #5d26c9;"><i class="fa-solid fa-wand-magic-sparkles"></i> Canva</a>
                            <button class="btn btn-sm btn-outline" onclick="document.getElementById('scheduleThumbnail').click()"><i class="fa-solid fa-upload"></i> Upload</button>
                        </div>
                        <input type="file" id="scheduleThumbnail" accept="image/*" hidden>
                    </div>

                    <!-- Hidden Video for Extraction -->
                    <video id="frameExtractorVideo" style="display: none;" crossorigin="anonymous"></video>

                    <!-- Progress -->
                    <div id="uploadProgressContainer" class="hidden">
                        <div class="progress-track"><div id="uploadProgressBar" class="progress-fill"></div></div>
                        <small id="uploadPercent">0%</small>
                    </div>

                    <!-- Details -->
                     <div class="form-row">
                        <div class="form-group">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                                <label style="margin:0;">Title</label>
                                <button class="tool-btn" onclick="aiGenerate('title')" title="AI Assist" style="padding:2px 8px; font-size:0.75rem;"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24" style="display:inline-block; vertical-align:middle; margin-right:4px;"><path d="M12 2C12.5 7.5 16.5 11.5 22 12C16.5 12.5 12.5 16.5 12 22C11.5 16.5 7.5 12.5 2 12C7.5 11.5 11.5 7.5 12 2Z"/></svg> AI Write</button>
                            </div>
                            <input type="text" id="scheduleTitle" class="form-input">
                        </div>
                         <div class="form-group">
                            <label>Time</label>
                            <input type="datetime-local" id="scheduleTime" class="form-input">
                        </div>
                    </div>

                    <div class="collapsible-details">
                         <div class="form-row">
                             <div class="form-group">
                                <label>Category</label>
                                <select id="scheduleCategory" class="form-input"></select>
                             </div>
                             <div class="form-group">
                                <label>Privacy</label>
                                <select id="schedulePrivacy" class="form-input">
                                    <option value="private">Private</option>
                                    <option value="public">Public</option>
                                </select>
                             </div>
                         </div>
                         <div class="form-group">
                             <div style="position:relative;">
                                 <input type="text" id="scheduleTags" placeholder="Tags (comma separated)" class="form-input" style="padding-right: 80px;">
                                 <button onclick="aiGenerate('tags')" style="position:absolute; right:5px; top:50%; transform:translateY(-50%); border:none; background:none; color:#2c68f6; cursor:pointer; font-size:0.8rem; display:flex; align-items:center; gap:4px;"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C12.5 7.5 16.5 11.5 22 12C16.5 12.5 12.5 16.5 12 22C11.5 16.5 7.5 12.5 2 12C7.5 11.5 11.5 7.5 12 2Z"/></svg> AI</button>
                             </div>
                         </div>

                         <div class="form-group">
                            <label>First Comment (Pinned)</label>
                            <textarea id="scheduleFirstComment" class="form-input" rows="2" placeholder="Post a comment immediately after upload..."></textarea>
                         </div>

                         <div style="margin-top:15px; padding-top:15px; border-top:1px solid #eee;">
                            <h4 style="margin:0 0 10px 0; font-size:0.95rem;">Audio & Music</h4>

                            <div style="display:flex; gap:10px; margin-bottom:10px;">
                                <button class="btn btn-sm btn-primary" id="tabAudioUpload" onclick="switchAudioTab('upload')">Upload</button>
                                <button class="btn btn-sm btn-outline" id="tabAudioLib" onclick="switchAudioTab('lib')">Stock Library</button>
                            </div>

                            <!-- Upload Tab -->
                            <div id="audioUploadSection">
                                <div class="form-group">
                                    <label>Backing Track (Optional)</label>
                                    <input type="file" id="scheduleAudio" accept=".mp3,.wav" class="form-control" style="font-size:0.9rem;">
                                </div>
                            </div>

                            <!-- Library Tab -->
                            <div id="audioLibSection" class="hidden">
                                <div id="audioTrackList" class="scroll-list" style="height:150px; border:1px solid #eee; border-radius:4px; margin-bottom:10px;">
                                    Loading...
                                </div>
                                <input type="hidden" id="selectedAudioTrackId">
                                <div id="selectedTrackName" style="font-size:0.85rem; font-weight:600; color:var(--primary);"></div>
                            </div>

                            <div class="form-group">
                                <label>Music Volume (<span id="volVal">50%</span>)</label>
                                <input type="range" id="scheduleAudioVol" min="0" max="200" value="50" style="width:100%" oninput="document.getElementById('volVal').innerText = this.value + '%'">
                                <div style="font-size:0.8rem; color:#888;">100% = Original volume. 200% = Boost.</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="composer-preview">
                    <div class="preview-card">
                        <div class="preview-card-header">
                            <i class="fa-brands fa-youtube" style="color:red"></i>
                            <span style="font-weight:600; font-size:0.9rem;">YouTube Preview</span>
                        </div>
                        <div style="display:flex; justify-content:space-between; align-items:center; padding: 0 10px 5px;">
                            <span style="font-size:0.8rem; color:#666;">Preview Mode:</span>
                            <div class="toggle-group">
                                <button class="btn btn-xs btn-primary" onclick="setPreviewMode('standard')">16:9</button>
                                <button class="btn btn-xs btn-outline" onclick="setPreviewMode('shorts')">9:16</button>
                            </div>
                        </div>

                        <div class="preview-card-image" id="previewImageMock">
                            <i class="fa-solid fa-play"></i>
                            <!-- Safe Zone Overlay for Shorts -->
                            <div id="shortsSafeZone" class="hidden" style="position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none;">
                                <div style="position:absolute; bottom:120px; right:10px; display:flex; flex-direction:column; gap:15px; color:rgba(255,255,255,0.7); align-items:center;">
                                    <i class="fa-solid fa-thumbs-up fa-lg"></i>
                                    <i class="fa-solid fa-comment-dots fa-lg"></i>
                                    <i class="fa-solid fa-share fa-lg"></i>
                                </div>
                                <div style="position:absolute; bottom:20px; left:10px; color:white; font-size:0.8rem;">
                                    <div style="width:30px; height:30px; background:#ccc; border-radius:50%; margin-bottom:5px;"></div>
                                    Channel Name
                                </div>
                            </div>
                        </div>
                        <div class="preview-card-body">
                            <h4 id="previewTitleMock" style="margin:0 0 5px 0; font-size:0.95rem;">Video Title</h4>
                            <div id="previewDescMock" style="font-size:0.85rem; color:#666; line-height:1.4;">
                                Description will appear here...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" id="btnSchedule" onclick="submitSchedule()">Schedule Post</button>
        </div>
    </div>
</div>

<!-- Auto Schedule Modal -->
<div id="autoScheduleModal" class="modal-overlay hidden">
    <div class="modal-box">
        <h3>Auto Schedule</h3>
        <p>Automatically distribute your library content.</p>
        <div class="form-group">
            <label>Start Date</label>
            <input type="date" id="autoStartDate" class="form-input">
        </div>
        <div class="form-group">
            <label>Times (HH:mm)</label>
            <input type="text" id="autoTimeSlots" placeholder="10:00, 15:00" class="form-input">
        </div>

        <div style="border-top:1px solid #eee; margin: 15px 0; padding-top:15px;">
            <h4 style="margin: 0 0 10px 0;">AI Enhancement</h4>
            <div class="form-group">
                <label>Base Topic (Optional)</label>
                <input type="text" id="autoTopic" placeholder="e.g. Minecraft Gameplay" class="form-input">
            </div>
            <div class="form-group" style="display:flex; align-items:center; gap:10px;">
                <input type="checkbox" id="autoUseAi">
                <label for="autoUseAi" style="margin:0; font-weight:400;">Generate Titles, Descriptions & Tags with AI</label>
            </div>
        </div>

        <div class="modal-actions">
            <button class="btn btn-primary" onclick="submitAutoSchedule()">Apply</button>
            <button class="btn btn-text" onclick="document.getElementById('autoScheduleModal').classList.add('hidden')">Cancel</button>
        </div>
    </div>
</div>

<!-- Stream Library Modal -->
<div id="streamLibraryModal" class="modal-overlay hidden">
    <div class="modal-box" style="width: 500px;">
        <div class="modal-header" style="border:none; padding-bottom: 10px;">
            <h2>Select Video</h2>
            <button onclick="document.getElementById('streamLibraryModal').classList.add('hidden')" class="btn-close"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div id="streamLibraryList" class="scroll-list" style="height: 300px; padding: 0;"></div>
    </div>
</div>

<!-- YouTube Import Modal -->
<div id="youtubeImportModal" class="modal-overlay hidden">
    <div class="modal-box" style="width: 450px;">
        <div class="modal-header" style="border:none; padding-bottom: 10px;">
            <h2>Import from YouTube</h2>
            <button onclick="document.getElementById('youtubeImportModal').classList.add('hidden')" class="btn-close"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="form-group">
            <label>Video URL</label>
            <input type="text" id="ytImportUrl" class="form-input" placeholder="https://youtube.com/watch?v=...">
            <small style="color:#666;">Video will be downloaded to your library.</small>
        </div>
        <div class="modal-actions" style="margin-top: 20px; text-align: right;">
            <button class="btn btn-text" onclick="document.getElementById('youtubeImportModal').classList.add('hidden')">Cancel</button>
            <button class="btn btn-primary" onclick="submitYouTubeImport()">Import</button>
        </div>
    </div>
</div>

<!-- Scheduled Streams List Modal -->
<div id="scheduledStreamsModal" class="modal-overlay hidden">
    <div class="modal-box" style="width: 600px;">
        <div class="modal-header" style="border:none; padding-bottom: 10px;">
            <h2>Scheduled Streams</h2>
            <button onclick="document.getElementById('scheduledStreamsModal').classList.add('hidden')" class="btn-close"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div id="scheduledStreamsList" class="scroll-list" style="max-height: 400px; overflow-y:auto; padding: 0;">
            Loading...
        </div>
    </div>
</div>


<!-- GLOBAL LOADER -->
<div id="globalLoader" class="fixed inset-0 z-[300] bg-gray-900/50 backdrop-blur-sm flex items-center justify-center hidden" style="display: none;">
    <div class="bg-white p-8 rounded-2xl shadow-2xl flex flex-col items-center animate-fade-in">
        <div class="afk-loader mb-4"></div>
        <p class="font-medium text-gray-700 text-lg" id="globalLoaderText">Processing...</p>
    </div>
</div>

<!-- GLOBAL ALPINE MODAL -->
<div x-data="$store.modal"
     x-show="open"
     class="fixed inset-0 z-[200] flex items-center justify-center p-4 bg-gray-900/50 backdrop-blur-sm"
     x-transition.opacity
     style="display: none;">

    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden transform transition-all"
         @click.outside="if(type === 'alert') cancel()"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 scale-95"
         x-transition:enter-end="opacity-100 scale-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100 scale-100"
         x-transition:leave-end="opacity-0 scale-95">

        <!-- Icon / Header -->
        <div class="p-6 text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full mb-4"
                 :class="{
                    'bg-red-100 text-red-600': type === 'confirm' && (title.toLowerCase().includes('delete') || title.toLowerCase().includes('stop') || title.toLowerCase().includes('disconnect') || title.toLowerCase().includes('cancel')),
                    'bg-blue-100 text-blue-600': !(type === 'confirm' && (title.toLowerCase().includes('delete') || title.toLowerCase().includes('stop') || title.toLowerCase().includes('disconnect') || title.toLowerCase().includes('cancel')))
                 }">
                <i class="fa-solid text-xl"
                   :class="{
                       'fa-triangle-exclamation': type === 'confirm' && (title.toLowerCase().includes('delete') || title.toLowerCase().includes('stop') || title.toLowerCase().includes('disconnect') || title.toLowerCase().includes('cancel')),
                       'fa-circle-info': type === 'alert',
                       'fa-circle-question': type === 'confirm' && !(title.toLowerCase().includes('delete') || title.toLowerCase().includes('stop') || title.toLowerCase().includes('disconnect') || title.toLowerCase().includes('cancel')),
                       'fa-pen': type === 'prompt'
                   }"></i>
            </div>

            <h3 class="text-lg leading-6 font-bold text-gray-900" x-text="title"></h3>
            <div class="mt-2">
                <p class="text-sm text-gray-500" x-text="message"></p>
            </div>

            <!-- Prompt Input -->
            <div x-show="type === 'prompt'" class="mt-4">
                <input type="text" id="modal-input" x-model="inputValue"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                       :placeholder="placeholder"
                       @keydown.enter="accept()">
            </div>
        </div>

        <!-- Actions -->
        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse gap-2">
            <button type="button"
                    class="w-full inline-flex justify-center rounded-lg border border-transparent shadow-sm px-4 py-2 text-base font-medium text-white focus:outline-none focus:ring-2 focus:ring-offset-2 sm:ml-3 sm:w-auto sm:text-sm transition"
                    :class="{
                        'bg-red-600 hover:bg-red-700 focus:ring-red-500': type === 'confirm' && (title.toLowerCase().includes('delete') || title.toLowerCase().includes('stop') || title.toLowerCase().includes('disconnect') || title.toLowerCase().includes('cancel')),
                        'bg-blue-600 hover:bg-blue-700 focus:ring-blue-500': !(type === 'confirm' && (title.toLowerCase().includes('delete') || title.toLowerCase().includes('stop') || title.toLowerCase().includes('disconnect') || title.toLowerCase().includes('cancel')))
                    }"
                    @click="accept()">
                <span x-text="type === 'alert' ? 'OK' : (type === 'confirm' ? 'Confirm' : 'Submit')"></span>
            </button>

            <button type="button" x-show="type !== 'alert'"
                    class="mt-3 w-full inline-flex justify-center rounded-lg border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm transition"
                    @click="cancel()">
                Cancel
            </button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="js/modal-service.js"></script>
<script src="js/toast.js"></script>
<script src="js/stream-studio.js"></script>
<script src="js/settings.js"></script>
<script src="js/content-management.js"></script>
<script src="js/app.js"></script>
</body>
</html>
